/*
 *    /\
 *   /  \ ot 0.0.11
 *  /    \ http://operational-transformation.github.com
 *  \    /
 *   \  / (c) 2012-2013 Tim Baumann <tim@timbaumann.info> (http://timbaumann.info)
 *    \/ ot may be freely distributed under the MIT license.
 */

if(ot===void 0)var ot={};if(ot.TextOperation=function(){function t(){return this.constructor!==t?new t:(this.ops=[],this.baseLength=0,this.targetLength=0,void 0)}t.prototype.equals=function(t){if(this.baseLength!==t.baseLength)return!1;if(this.targetLength!==t.targetLength)return!1;if(this.ops.length!==t.ops.length)return!1;for(var e=0;this.ops.length>e;e++)if(this.ops[e]!==t.ops[e])return!1;return!0};var e=t.isRetain=function(t){return"number"==typeof t&&t>0},o=t.isInsert=function(t){return"string"==typeof t},r=t.isDelete=function(t){return"number"==typeof t&&0>t};return t.prototype.retain=function(t){if("number"!=typeof t)throw Error("retain expects an integer");return 0===t?this:(this.baseLength+=t,this.targetLength+=t,e(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=t:this.ops.push(t),this)},t.prototype.insert=function(t){if("string"!=typeof t)throw Error("insert expects a string");if(""===t)return this;this.targetLength+=t.length;var e=this.ops;return o(e[e.length-1])?e[e.length-1]+=t:r(e[e.length-1])?o(e[e.length-2])?e[e.length-2]+=t:(e[e.length]=e[e.length-1],e[e.length-2]=t):e.push(t),this},t.prototype["delete"]=function(t){if("string"==typeof t&&(t=t.length),"number"!=typeof t)throw Error("delete expects an integer or a string");return 0===t?this:(t>0&&(t=-t),this.baseLength-=t,r(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=t:this.ops.push(t),this)},t.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&e(this.ops[0])},t.prototype.toString=function(){var t=Array.prototype.map||function(t){for(var e=this,o=[],r=0,n=e.length;n>r;r++)o[r]=t(e[r]);return o};return t.call(this.ops,function(t){return e(t)?"retain "+t:o(t)?"insert '"+t+"'":"delete "+-t}).join(", ")},t.prototype.toJSON=function(){return this.ops},t.fromJSON=function(n){for(var i=new t,s=0,a=n.length;a>s;s++){var p=n[s];if(e(p))i.retain(p);else if(o(p))i.insert(p);else{if(!r(p))throw Error("unknown operation: "+JSON.stringify(p));i["delete"](p)}}return i},t.prototype.apply=function(t){var r=this;if(t.length!==r.baseLength)throw Error("The operation's base length must be equal to the string's length.");for(var n=[],i=0,s=0,a=this.ops,p=0,h=a.length;h>p;p++){var u=a[p];if(e(u)){if(s+u>t.length)throw Error("Operation can't retain more characters than are left in the string.");n[i++]=t.slice(s,s+u),s+=u}else o(u)?n[i++]=u:s-=u}if(s!==t.length)throw Error("The operation didn't operate on the whole string.");return n.join("")},t.prototype.invert=function(r){for(var n=0,i=new t,s=this.ops,a=0,p=s.length;p>a;a++){var h=s[a];e(h)?(i.retain(h),n+=h):o(h)?i["delete"](h.length):(i.insert(r.slice(n,n-h)),n-=h)}return i},t.prototype.compose=function(n){var i=this;if(i.targetLength!==n.baseLength)throw Error("The base length of the second operation has to be the target length of the first operation");for(var s=new t,a=i.ops,p=n.ops,h=0,u=0,c=a[h++],l=p[u++];;){if(c===void 0&&l===void 0)break;if(r(c))s["delete"](c),c=a[h++];else if(o(l))s.insert(l),l=p[u++];else{if(c===void 0)throw Error("Cannot compose operations: first operation is too short.");if(l===void 0)throw Error("Cannot compose operations: fist operation is too long.");if(e(c)&&e(l))c>l?(s.retain(l),c-=l,l=p[u++]):c===l?(s.retain(c),c=a[h++],l=p[u++]):(s.retain(c),l-=c,c=a[h++]);else if(o(c)&&r(l))c.length>-l?(c=c.slice(-l),l=p[u++]):c.length===-l?(c=a[h++],l=p[u++]):(l+=c.length,c=a[h++]);else if(o(c)&&e(l))c.length>l?(s.insert(c.slice(0,l)),c=c.slice(l),l=p[u++]):c.length===l?(s.insert(c),c=a[h++],l=p[u++]):(s.insert(c),l-=c.length,c=a[h++]);else{if(!e(c)||!r(l))throw Error("This shouldn't happen: op1: "+JSON.stringify(c)+", op2: "+JSON.stringify(l));c>-l?(s["delete"](l),c+=l,l=p[u++]):c===-l?(s["delete"](l),c=a[h++],l=p[u++]):(s["delete"](c),l+=c,c=a[h++])}}}return s},t.prototype.shouldBeComposedWith=function(n){function i(e){var o=e.ops,r=t.isRetain;switch(o.length){case 1:return o[0];case 2:return r(o[0])?o[1]:r(o[1])?o[0]:null;case 3:if(r(o[0])&&r(o[2]))return o[1]}return null}function s(t){return e(t.ops[0])?t.ops[0]:0}if(this.isNoop()||n.isNoop())return!0;var a=s(this),p=s(n),h=i(this),u=i(n);return h&&u?o(h)&&o(u)?a+h.length===p:r(h)&&r(u)?p-u===a||a===p:!1:!1},t.transform=function(n,i){if(n.baseLength!==i.baseLength)throw Error("Both operations have to have the same base length");for(var s=new t,a=new t,p=n.ops,h=i.ops,u=0,c=0,l=p[u++],f=h[c++];;){if(l===void 0&&f===void 0)break;if(o(l))s.insert(l),a.retain(l.length),l=p[u++];else if(o(f))s.retain(f.length),a.insert(f),f=h[c++];else{if(l===void 0)throw Error("Cannot compose operations: first operation is too short.");if(f===void 0)throw Error("Cannot compose operations: first operation is too long.");var d;if(e(l)&&e(f))l>f?(d=f,l-=f,f=h[c++]):l===f?(d=f,l=p[u++],f=h[c++]):(d=l,f-=l,l=p[u++]),s.retain(d),a.retain(d);else if(r(l)&&r(f))-l>-f?(l-=f,f=h[c++]):l===f?(l=p[u++],f=h[c++]):(f-=l,l=p[u++]);else if(r(l)&&e(f))-l>f?(d=f,l+=f,f=h[c++]):-l===f?(d=f,l=p[u++],f=h[c++]):(d=-l,f+=l,l=p[u++]),s["delete"](d);else{if(!e(l)||!r(f))throw Error("The two operations aren't compatible");l>-f?(d=-f,l+=f,f=h[c++]):l===-f?(d=l,l=p[u++],f=h[c++]):(d=l,f+=l,l=p[u++]),a["delete"](d)}}}return[s,a]},t}(),"object"==typeof module&&(module.exports=ot.TextOperation),ot===void 0)var ot={};if(ot.Cursor=function(t){function e(t,e){this.position=t,this.selectionEnd=e}var o=t.ot?t.ot.TextOperation:require("./text-operation");return e.fromJSON=function(t){return new e(t.position,t.selectionEnd)},e.prototype.equals=function(t){return this.position===t.position&&this.selectionEnd===t.selectionEnd},e.prototype.compose=function(t){return t},e.prototype.transform=function(t){function r(e){for(var r=e,n=t.ops,i=0,s=t.ops.length;s>i&&(o.isRetain(n[i])?e-=n[i]:o.isInsert(n[i])?r+=n[i].length:(r-=Math.min(e,-n[i]),e+=n[i]),!(0>e));i++);return r}var n=r(this.position);return this.position===this.selectionEnd?new e(n,n):new e(n,r(this.selectionEnd))},e}(this),"object"==typeof module&&(module.exports=ot.Cursor),ot===void 0)var ot={};if(ot.WrappedOperation=function(){function t(t,e){this.wrapped=t,this.meta=e}function e(t,e){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])}function o(t,o){if(t&&"object"==typeof t){if("function"==typeof t.compose)return t.compose(o);var r={};return e(t,r),e(o,r),r}return o}function r(t,e){return t&&"object"==typeof t&&"function"==typeof t.transform?t.transform(e):t}return t.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},t.prototype.invert=function(){var e=this.meta;return new t(this.wrapped.invert.apply(this.wrapped,arguments),e&&"object"==typeof e&&"function"==typeof e.invert?e.invert.apply(e,arguments):e)},t.prototype.compose=function(e){return new t(this.wrapped.compose(e.wrapped),o(this.meta,e.meta))},t.transform=function(e,o){var n=e.wrapped.constructor.transform,i=n(e.wrapped,o.wrapped);return[new t(i[0],r(e.meta,o.wrapped)),new t(i[1],r(o.meta,e.wrapped))]},t}(this),"object"==typeof module&&(module.exports=ot.WrappedOperation),ot===void 0)var ot={};if(ot.UndoManager=function(){function t(t){this.maxItems=t||50,this.state=o,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function e(t,e){for(var o=[],r=e.constructor,n=t.length-1;n>=0;n--){var i=r.transform(t[n],e);"function"==typeof i[0].isNoop&&i[0].isNoop()||o.push(i[0]),e=i[1]}return o.reverse()}var o="normal",r="undoing",n="redoing";return t.prototype.add=function(t,e){if(this.state===r)this.redoStack.push(t),this.dontCompose=!0;else if(this.state===n)this.undoStack.push(t),this.dontCompose=!0;else{var o=this.undoStack;!this.dontCompose&&e&&o.length>0?o.push(t.compose(o.pop())):(o.push(t),o.length>this.maxItems&&o.shift()),this.dontCompose=!1,this.redoStack=[]}},t.prototype.transform=function(t){this.undoStack=e(this.undoStack,t),this.redoStack=e(this.redoStack,t)},t.prototype.performUndo=function(t){if(this.state=r,0===this.undoStack.length)throw Error("undo not possible");t(this.undoStack.pop()),this.state=o},t.prototype.performRedo=function(t){if(this.state=n,0===this.redoStack.length)throw Error("redo not possible");t(this.redoStack.pop()),this.state=o},t.prototype.canUndo=function(){return 0!==this.undoStack.length},t.prototype.canRedo=function(){return 0!==this.redoStack.length},t.prototype.isUndoing=function(){return this.state===r},t.prototype.isRedoing=function(){return this.state===n},t}(),"object"==typeof module&&(module.exports=ot.UndoManager),ot===void 0)var ot={};ot.Client=function(){function t(t){this.revision=t,this.state=n}function e(){}function o(t){this.outstanding=t}function r(t,e){this.outstanding=t,this.buffer=e}t.prototype.setState=function(t){this.state=t},t.prototype.applyClient=function(t){this.setState(this.state.applyClient(this,t))},t.prototype.applyServer=function(t){this.revision++,this.setState(this.state.applyServer(this,t))},t.prototype.serverAck=function(){this.revision++,this.setState(this.state.serverAck(this))},t.prototype.serverReconnect=function(){"function"==typeof this.state.resend&&this.state.resend(this)},t.prototype.transformCursor=function(t){return this.state.transformCursor(t)},t.prototype.sendOperation=function(){throw Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(){throw Error("applyOperation must be defined in child class")},t.Synchronized=e,e.prototype.applyClient=function(t,e){return t.sendOperation(t.revision,e),new o(e)},e.prototype.applyServer=function(t,e){return t.applyOperation(e),this},e.prototype.serverAck=function(){throw Error("There is no pending operation.")},e.prototype.transformCursor=function(t){return t};var n=new e;return t.AwaitingConfirm=o,o.prototype.applyClient=function(t,e){return new r(this.outstanding,e)},o.prototype.applyServer=function(t,e){var r=e.constructor.transform(this.outstanding,e);return t.applyOperation(r[1]),new o(r[0])},o.prototype.serverAck=function(){return n},o.prototype.transformCursor=function(t){return t.transform(this.outstanding)},o.prototype.resend=function(t){t.sendOperation(t.revision,this.outstanding)},t.AwaitingWithBuffer=r,r.prototype.applyClient=function(t,e){var o=this.buffer.compose(e);return new r(this.outstanding,o)},r.prototype.applyServer=function(t,e){var o=e.constructor.transform,n=o(this.outstanding,e),i=o(this.buffer,n[1]);return t.applyOperation(i[1]),new r(n[0],i[0])},r.prototype.serverAck=function(t){return t.sendOperation(t.revision,this.buffer),new o(this.buffer)},r.prototype.transformCursor=function(t){return t.transform(this.outstanding).transform(this.buffer)},r.prototype.resend=function(t){t.sendOperation(t.revision,this.outstanding)},t}(this),"object"==typeof module&&(module.exports=ot.Client),ot.CodeMirrorAdapter=function(){function t(t){this.cm=t,this.ignoreNextChange=!1,this.oldValue=this.cm.getValue(),o(this,"onChange"),o(this,"onCursorActivity"),o(this,"onFocus"),o(this,"onBlur"),t.on("change",this.onChange),t.on("cursorActivity",this.onCursorActivity),t.on("focus",this.onFocus),t.on("blur",this.onBlur)}function e(t,e){if(!t)throw Error(e||"assertion error")}function o(t,e){var o=t[e];t[e]=function(){o.apply(t,arguments)}}var r=ot.TextOperation,n=ot.Cursor;t.prototype.detach=function(){this.cm.off("change",this.onChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},t.operationFromCodeMirrorChange=function(t,e){function o(t){for(var e=(t.line,t.ch),o=0,r=0;t.line>r;r++)o+=h[r].length+1;return o+=e}function n(){for(var t=0,e=0,o=h.length;o>e;e++)t+=h[e].length;return t+h.length-1}function i(t,e){if(t.line===e.line)return h[t.line].slice(t.ch,e.ch);for(var o=h[t.line].slice(t.ch)+"\n",r=t.line+1;e.line>r;r++)o+=h[r]+"\n";return o+=h[e.line].slice(0,e.ch)}function s(t,e,o){var r=t.slice(0),n=h[e.line].slice(0,e.ch),i=h[o.line].slice(o.ch);r[0]=n+r[0],r[r.length-1]+=i,r.unshift(o.line-e.line+1),r.unshift(e.line),h.splice.apply(h,r)}function a(t,e){var r=o(e.from),a=o(e.to),p=n();t.retain(r),t["delete"](i(e.from,e.to)),t.insert(e.text.join("\n")),t.retain(p-a),s(e.text,e.from,e.to)}var p=new r,h=e.split("\n");for(a(p,t);;){if(t=t.next,!t)break;var u=new r(p.revision+1);a(u,t),p=p.compose(u)}return p},t.applyOperationToCodeMirror=function(t,o){o.operation(function(){for(var n=t.ops,i=0,s=0,a=n.length;a>s;s++){var p=n[s];if(r.isRetain(p))i+=p;else if(r.isInsert(p))o.replaceRange(p,o.posFromIndex(i)),i+=p.length;else if(r.isDelete(p)){var h=o.posFromIndex(i),u=o.posFromIndex(i-p);o.replaceRange("",h,u)}}e(i===o.getValue().length)})},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.onChange=function(e,o){if(!this.ignoreNextChange){var r=t.operationFromCodeMirrorChange(o,this.oldValue);this.trigger("change",this.oldValue,r)}this.ignoreNextChange=!1,this.oldValue=this.cm.getValue()},t.prototype.onCursorActivity=t.prototype.onFocus=function(){this.trigger("cursorActivity")},t.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},t.prototype.getValue=function(){return this.oldValue},t.prototype.getCursor=function(){function t(t,e){return t.line===e.line&&t.ch===e.ch}var e,o=this.cm,r=o.getCursor(),i=o.indexFromPos(r);if(o.somethingSelected()){var s=o.getCursor(!0),a=t(r,s)?o.getCursor(!1):s;e=o.indexFromPos(a)}else e=i;return new n(i,e)},t.prototype.setCursor=function(t){this.cm.setSelection(this.cm.posFromIndex(t.position),this.cm.posFromIndex(t.selectionEnd))};var i=function(){var t={},e=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(e);var o=e.sheet;return function(e){t[e]||(t[e]=!0,o.insertRule(e,(o.cssRules||o.rules).length))}}();return t.prototype.setOtherCursor=function(t,e,o){var r=this.cm.posFromIndex(t.position);if(t.position===t.selectionEnd){var n=this.cm.cursorCoords(r),s=document.createElement("pre");return s.className="other-client",s.style.borderLeftWidth="2px",s.style.borderLeftStyle="solid",s.innerHTML="&nbsp;",s.style.borderLeftColor=e,s.style.height=.9*(n.bottom-n.top)+"px",s.style.marginTop=n.top-n.bottom+"px",s.setAttribute("data-clientid",o),this.cm.addWidget(r,s,!1),{clear:function(){var t=s.parentNode;t&&t.removeChild(s)}}}var a=/^#([0-9a-fA-F]{6})$/.exec(e);if(!a)throw Error("only six-digit hex colors are allowed.");var p="selection-"+a[1],h="."+p+" { background: "+e+"; }";i(h);var u,c;return t.selectionEnd>t.position?(u=r,c=this.cm.posFromIndex(t.selectionEnd)):(u=this.cm.posFromIndex(t.selectionEnd),c=r),this.cm.markText(u,c,{className:p})},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),o=this.callbacks&&this.callbacks[t];o&&o.apply(this,e)},t.prototype.applyOperation=function(e){this.ignoreNextChange=!0,t.applyOperationToCodeMirror(e,this.cm)},t.prototype.registerUndo=function(t){this.cm.undo=t},t.prototype.registerRedo=function(t){this.cm.redo=t},t}(),ot.SocketIOAdapter=function(){function t(t){this.socket=t;var e=this;t.on("client_left",function(t){e.trigger("client_left",t)}).on("set_name",function(t,o){e.trigger("set_name",t,o)}).on("ack",function(){e.trigger("ack")}).on("operation",function(t,o,r){e.trigger("operation",o),e.trigger("cursor",t,r)}).on("cursor",function(t,o){e.trigger("cursor",t,o)}).on("reconnect",function(){e.trigger("reconnect")})}return t.prototype.sendOperation=function(t,e,o){this.socket.emit("operation",t,e,o)},t.prototype.sendCursor=function(t){this.socket.emit("cursor",t)},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),o=this.callbacks&&this.callbacks[t];o&&o.apply(this,e)},t}(),ot.AjaxAdapter=function(){function t(t,e){"/"!==t[t.length-1]&&(t+="/"),this.path=t,this.revision=e,this.poll()}return t.prototype.poll=function(){var t=this;this.xhr=$.ajax({url:this.path+"revision/"+this.revision,type:"GET",dataType:"json",success:function(e){for(var o=e.operations,r=0;o.length>r;r++)t.trigger("operation",o[r]);t.revision+=o.length,t.poll()},error:function(e,o){"abort"!==o&&setTimeout(function(){t.poll()},500)}})},t.prototype.sendOperation=function(t,e,o){if(this.xhr&&this.xhr.abort(),t!==this.revision)throw Error("Revision numbers out of sync");var r=this;this.xhr=$.ajax({url:this.path+"revision/"+t,type:"POST",data:JSON.stringify({operation:e,cursor:o}),contentType:"application/json",processData:!1,success:function(t){for(var e=t.operations,o=0;e.length-1>o;o++)r.trigger("operation",e[o]);r.revision+=e.length,r.trigger("ack"),r.poll()},error:function(){setTimeout(function(){r.sendOperation(t,e,o)},500)}})},t.prototype.sendCursor=function(t){$.ajax({url:this.path+"cursor",type:"POST",data:JSON.stringify(t),contentType:"application/json",processData:!1,timeout:1e3})},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),o=this.callbacks&&this.callbacks[t];o&&o.apply(this,e)},t}(),ot.EditorClient=function(){function t(t,e){this.cursorBefore=t,this.cursorAfter=e}function e(t,e){this.clientId=t,this.cursor=e}function o(t,e,o,r,n){this.id=t,this.listEl=e,this.editorAdapter=o,this.name=r,this.li=document.createElement("li"),r&&(this.li.textContent=r,this.listEl.appendChild(this.li)),this.setColor(r?s(r):Math.random()),n&&this.updateCursor(n)}function r(t,e,o,r){u.call(this,t),this.serverAdapter=o,this.editorAdapter=r,this.undoManager=new l,this.initializeClientList(),this.initializeClients(e);var n=this;this.editorAdapter.registerCallbacks({change:function(t,e){n.onChange(t,e)},cursorActivity:function(){n.onCursorActivity()},blur:function(){n.onBlur()}}),this.editorAdapter.registerUndo(function(){n.undo()}),this.editorAdapter.registerRedo(function(){n.redo()}),this.serverAdapter.registerCallbacks({client_left:function(t){n.onClientLeft(t)},set_name:function(t,e){n.getClientObject(t).setName(e)},ack:function(){n.serverAck()},operation:function(t){n.applyServer(f.fromJSON(t))},cursor:function(t,e){e?n.getClientObject(t).updateCursor(n.transformCursor(c.fromJSON(e))):n.getClientObject(t).removeCursor()},reconnect:function(){n.serverReconnect()}})}function n(t,e,o){function r(t){var e=Math.round(255*t).toString(16);return 1===e.length?"0"+e:e}return"#"+r(t)+r(e)+r(o)}function i(t,e,o){if(0===e)return n(o,o,o);var r=.5>o?o*(1+e):o+e-e*o,i=2*o-r,s=function(t){return 0>t&&(t+=1),t>1&&(t-=1),1>6*t?i+6*(r-i)*t:1>2*t?r:2>3*t?i+6*(r-i)*(2/3-t):i};return n(s(t+1/3),s(t),s(t-1/3))}function s(t){for(var e=1,o=0;t.length>o;o++)e=17*(e+t.charCodeAt(o))%360;return e/360}function a(t,e){function o(){}o.prototype=e.prototype,t.prototype=new o,t.prototype.constructor=t}function p(t){return t[t.length-1]}function h(t){t.parentNode&&t.parentNode.removeChild(t)}var u=ot.Client,c=ot.Cursor,l=ot.UndoManager,f=ot.TextOperation,d=ot.WrappedOperation;return t.prototype.invert=function(){return new t(this.cursorAfter,this.cursorBefore)},t.prototype.compose=function(e){return new t(this.cursorBefore,e.cursorAfter)},t.prototype.transform=function(e){return new t(this.cursorBefore.transform(e),this.cursorAfter.transform(e))},e.fromJSON=function(t){return new e(t.clientId,t.cursor&&c.fromJSON(t.cursor))},e.prototype.transform=function(t){return new e(this.clientId,this.cursor&&this.cursor.transform(t))},o.prototype.setColor=function(t){this.hue=t,this.color=i(t,.75,.5),this.lightColor=i(t,.5,.9),this.li&&(this.li.style.color=this.color)},o.prototype.setName=function(t){this.name=t,this.li.textContent=t,this.li.parentNode||this.listEl.appendChild(this.li),this.setColor(s(t))},o.prototype.updateCursor=function(t){this.removeCursor(),this.cursor=t,this.mark=this.editorAdapter.setOtherCursor(t,t.position===t.selectionEnd?this.color:this.lightColor,this.id)},o.prototype.remove=function(){this.li&&h(this.li),this.removeCursor()},o.prototype.removeCursor=function(){this.mark&&this.mark.clear()},a(r,u),r.prototype.initializeClients=function(t){this.clients={};for(var e in t)if(t.hasOwnProperty(e)){var r=t[e];r.clientId=e,this.clients[e]=new o(r.clientId,this.clientListEl,this.editorAdapter,r.name,r.cursor?c.fromJSON(r.cursor):null)}},r.prototype.getClientObject=function(t){var e=this.clients[t];return e?e:this.clients[t]=new o(t,this.clientListEl,this.editorAdapter)},r.prototype.onClientLeft=function(t){console.log("User disconnected: "+t);var e=this.clients[t];e&&(e.remove(),delete this.clients[t])},r.prototype.initializeClientList=function(){this.clientListEl=document.createElement("ul")},r.prototype.applyUnredo=function(t){this.undoManager.add(t.invert(this.editorAdapter.getValue())),this.editorAdapter.applyOperation(t.wrapped),this.cursor=t.meta.cursorAfter,this.editorAdapter.setCursor(this.cursor),this.applyClient(t)},r.prototype.undo=function(){var t=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(e){t.applyUnredo(e)})},r.prototype.redo=function(){var t=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(e){t.applyUnredo(e)})},r.prototype.onChange=function(e,o){var r=this.cursor;this.updateCursor();var n=new t(r,this.cursor),i=new d(o,n),s=this.undoManager.undoStack.length>0&&!this.undoManager.dontCompose&&p(this.undoManager.undoStack).wrapped.invert(e).shouldBeComposedWith(o);this.undoManager.add(i.invert(e),s),this.applyClient(o)},r.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor()},r.prototype.onCursorActivity=function(){var t=this.cursor;this.updateCursor(),t&&this.cursor.equals(t)||this.sendCursor(this.cursor)},r.prototype.onBlur=function(){this.cursor=null,this.sendCursor(null)},r.prototype.sendCursor=function(t){this.state instanceof u.AwaitingWithBuffer||this.serverAdapter.sendCursor(t)},r.prototype.sendOperation=function(t,e){this.serverAdapter.sendOperation(t,e.toJSON(),this.cursor)},r.prototype.applyOperation=function(t){this.editorAdapter.applyOperation(t),this.updateCursor(),this.undoManager.transform(new d(t,null))},r}();