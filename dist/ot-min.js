/*
 *    /\
 *   /  \ ot 0.0.20
 *  /    \ http://operational-transformation.github.com
 *  \    /
 *   \  / (c) 2012-2020 Tim Baumann <tim@timbaumann.info> (http://timbaumann.info), Max Wu <jackymaxj@gmail.com>
 *    \/ ot may be freely distributed under the MIT license.
 */


var ot;void 0===ot&&(ot={}),ot.TextOperation=function(){"use strict";function l(){if(!this||this.constructor!==l)return new l;this.ops=[],this.baseLength=0,this.targetLength=0}l.prototype.equals=function(t){if(this.baseLength!==t.baseLength)return!1;if(this.targetLength!==t.targetLength)return!1;if(this.ops.length!==t.ops.length)return!1;for(var e=0;e<this.ops.length;e++)if(this.ops[e]!==t.ops[e])return!1;return!0};var u=l.isRetain=function(t){return"number"==typeof t&&0<t},f=l.isInsert=function(t){return"string"==typeof t},g=l.isDelete=function(t){return"number"==typeof t&&t<0};function i(t){var e=t.ops,n=l.isRetain;switch(e.length){case 1:return e[0];case 2:return n(e[0])?e[1]:n(e[1])?e[0]:null;case 3:if(n(e[0])&&n(e[2]))return e[1]}return null}function s(t){return u(t.ops[0])?t.ops[0]:0}return l.prototype.retain=function(t){if("number"!=typeof t)throw new Error("retain expects an integer");return 0===t||(this.baseLength+=t,this.targetLength+=t,u(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=t:this.ops.push(t)),this},l.prototype.insert=function(t){if("string"!=typeof t)throw new Error("insert expects a string");if(""===t)return this;this.targetLength+=t.length;var e=this.ops;return f(e[e.length-1])?e[e.length-1]+=t:g(e[e.length-1])?f(e[e.length-2])?e[e.length-2]+=t:(e[e.length]=e[e.length-1],e[e.length-2]=t):e.push(t),this},l.prototype.delete=function(t){if("string"==typeof t&&(t=t.length),"number"!=typeof t)throw new Error("delete expects an integer or a string");return 0===t||(0<t&&(t=-t),this.baseLength-=t,g(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=t:this.ops.push(t)),this},l.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&u(this.ops[0])},l.prototype.toString=function(){return(Array.prototype.map||function(t){for(var e=[],n=0,o=this.length;n<o;n++)e[n]=t(this[n]);return e}).call(this.ops,function(t){return u(t)?"retain "+t:f(t)?"insert '"+t+"'":"delete "+-t}).join(", ")},l.prototype.toJSON=function(){return this.ops},l.fromJSON=function(t){for(var e=new l,n=0,o=t.length;n<o;n++){var r=t[n];if(u(r))e.retain(r);else if(f(r))e.insert(r);else{if(!g(r))throw new Error("unknown operation: "+JSON.stringify(r));e.delete(r)}}return e},l.prototype.apply=function(t){if(t.length!==this.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var e=[],n=0,o=0,r=this.ops,i=0,s=r.length;i<s;i++){var a=r[i];if(u(a)){if(o+a>t.length)throw new Error("Operation can't retain more characters than are left in the string.");e[n++]=t.slice(o,o+a),o+=a}else f(a)?e[n++]=a:o-=a}if(o!==t.length)throw new Error("The operation didn't operate on the whole string.");return e.join("")},l.prototype.invert=function(t){for(var e=0,n=new l,o=this.ops,r=0,i=o.length;r<i;r++){var s=o[r];u(s)?(n.retain(s),e+=s):f(s)?n.delete(s.length):(n.insert(t.slice(e,e-s)),e-=s)}return n},l.prototype.compose=function(t){if(this.targetLength!==t.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");for(var e=new l,n=this.ops,o=t.ops,r=0,i=0,s=n[r++],a=o[i++];void 0!==s||void 0!==a;)if(g(s))e.delete(s),s=n[r++];else if(f(a))e.insert(a),a=o[i++];else{if(void 0===s)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===a)throw new Error("Cannot compose operations: first operation is too long.");if(u(s)&&u(a))a<s?(e.retain(a),s-=a,a=o[i++]):s===a?(e.retain(s),s=n[r++],a=o[i++]):(e.retain(s),a-=s,s=n[r++]);else if(f(s)&&g(a))s.length>-a?(s=s.slice(-a),a=o[i++]):s.length===-a?(s=n[r++],a=o[i++]):(a+=s.length,s=n[r++]);else if(f(s)&&u(a))s.length>a?(e.insert(s.slice(0,a)),s=s.slice(a),a=o[i++]):s.length===a?(e.insert(s),s=n[r++],a=o[i++]):(e.insert(s),a-=s.length,s=n[r++]);else{if(!u(s)||!g(a))throw new Error("This shouldn't happen: op1: "+JSON.stringify(s)+", op2: "+JSON.stringify(a));-a<s?(e.delete(a),s+=a,a=o[i++]):s===-a?(e.delete(a),s=n[r++],a=o[i++]):(e.delete(s),a+=s,s=n[r++])}}return e},l.prototype.shouldBeComposedWith=function(t){if(this.isNoop()||t.isNoop())return!0;var e=s(this),n=s(t),o=i(this),r=i(t);return!(!o||!r)&&(f(o)&&f(r)?e+o.length===n:!(!g(o)||!g(r))&&(n-r===e||e===n))},l.prototype.shouldBeComposedWithInverted=function(t){if(this.isNoop()||t.isNoop())return!0;var e=s(this),n=s(t),o=i(this),r=i(t);return!(!o||!r)&&(f(o)&&f(r)?e+o.length===n||e===n:!(!g(o)||!g(r))&&n-r===e)},l.transform=function(t,e){if(t.baseLength!==e.baseLength)throw new Error("Both operations have to have the same base length");for(var n,o=new l,r=new l,i=t.ops,s=e.ops,a=0,h=0,p=i[a++],c=s[h++];void 0!==p||void 0!==c;)if(f(p))o.insert(p),r.retain(p.length),p=i[a++];else if(f(c))o.retain(c.length),r.insert(c),c=s[h++];else{if(void 0===p)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===c)throw new Error("Cannot compose operations: first operation is too long.");if(u(p)&&u(c))c<p?(p-=n=c,c=s[h++]):p===c?(n=c,p=i[a++],c=s[h++]):(c-=n=p,p=i[a++]),o.retain(n),r.retain(n);else if(g(p)&&g(c))-c<-p?(p-=c,c=s[h++]):p===c?(p=i[a++],c=s[h++]):(c-=p,p=i[a++]);else if(g(p)&&u(c))c<-p?(p+=n=c,c=s[h++]):-p===c?(n=c,p=i[a++],c=s[h++]):(n=-p,c+=p,p=i[a++]),o.delete(n);else{if(!u(p)||!g(c))throw new Error("The two operations aren't compatible");-c<p?(n=-c,p+=c,c=s[h++]):p===-c?(n=p,p=i[a++],c=s[h++]):(c+=n=p,p=i[a++]),r.delete(n)}}return[o,r]},l}(),"object"==typeof module&&(module.exports=ot.TextOperation),void 0===ot&&(ot={}),ot.Selection=function(t){"use strict";var s=t.ot?t.ot.TextOperation:require("./text-operation");function r(t,e){this.anchor=t,this.head=e}function i(t){this.ranges=t||[]}return r.fromJSON=function(t){return new r(t.anchor,t.head)},r.prototype.equals=function(t){return this.anchor===t.anchor&&this.head===t.head},r.prototype.isEmpty=function(){return this.anchor===this.head},r.prototype.transform=function(i){function t(t){for(var e=t,n=i.ops,o=0,r=i.ops.length;o<r&&(s.isRetain(n[o])?t-=n[o]:s.isInsert(n[o])?e+=n[o].length:(e-=Math.min(t,-n[o]),t+=n[o]),!(t<0));o++);return e}var e=t(this.anchor);return this.anchor===this.head?new r(e,e):new r(e,t(this.head))},i.Range=r,i.createCursor=function(t){return new i([new r(t,t)])},i.fromJSON=function(t){for(var e=t.ranges||t,n=0,o=[];n<e.length;n++)o[n]=r.fromJSON(e[n]);return new i(o)},i.prototype.equals=function(t){if(this.position!==t.position)return!1;if(this.ranges.length!==t.ranges.length)return!1;for(var e=0;e<this.ranges.length;e++)if(!this.ranges[e].equals(t.ranges[e]))return!1;return!0},i.prototype.somethingSelected=function(){for(var t=0;t<this.ranges.length;t++)if(!this.ranges[t].isEmpty())return!0;return!1},i.prototype.compose=function(t){return t},i.prototype.transform=function(t){for(var e=0,n=[];e<this.ranges.length;e++)n[e]=this.ranges[e].transform(t);return new i(n)},i}(this),"object"==typeof module&&(module.exports=ot.Selection),void 0===ot&&(ot={}),ot.WrappedOperation=function(){"use strict";function o(t,e){this.wrapped=t,this.meta=e}function r(t,e){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}function i(t,e){return t&&"object"==typeof t&&"function"==typeof t.transform?t.transform(e):t}return o.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},o.prototype.invert=function(){var t=this.meta;return new o(this.wrapped.invert.apply(this.wrapped,arguments),t&&"object"==typeof t&&"function"==typeof t.invert?t.invert.apply(t,arguments):t)},o.prototype.compose=function(t){return new o(this.wrapped.compose(t.wrapped),function(t,e){if(t&&"object"==typeof t){if("function"==typeof t.compose)return t.compose(e);var n={};return r(t,n),r(e,n),n}return e}(this.meta,t.meta))},o.transform=function(t,e){var n=(0,t.wrapped.constructor.transform)(t.wrapped,e.wrapped);return[new o(n[0],i(t.meta,e.wrapped)),new o(n[1],i(e.meta,t.wrapped))]},o}(),"object"==typeof module&&(module.exports=ot.WrappedOperation),void 0===ot&&(ot={}),ot.UndoManager=function(){"use strict";var e="normal",o="undoing",r="redoing";function t(t){this.maxItems=t||50,this.state=e,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function n(t,e){for(var n=[],o=e.constructor,r=t.length-1;0<=r;r--){var i=o.transform(t[r],e);"function"==typeof i[0].isNoop&&i[0].isNoop()||n.push(i[0]),e=i[1]}return n.reverse()}return t.prototype.add=function(t,e){var n;this.state===o?(this.redoStack.push(t),this.dontCompose=!0):this.state===r?(this.undoStack.push(t),this.dontCompose=!0):(n=this.undoStack,!this.dontCompose&&e&&0<n.length?n.push(t.compose(n.pop())):(n.push(t),n.length>this.maxItems&&n.shift()),this.dontCompose=!1,this.redoStack=[])},t.prototype.transform=function(t){this.undoStack=n(this.undoStack,t),this.redoStack=n(this.redoStack,t)},t.prototype.performUndo=function(t){if(this.state=o,0===this.undoStack.length)throw new Error("undo not possible");t(this.undoStack.pop()),this.state=e},t.prototype.performRedo=function(t){if(this.state=r,0===this.redoStack.length)throw new Error("redo not possible");t(this.redoStack.pop()),this.state=e},t.prototype.canUndo=function(){return 0!==this.undoStack.length},t.prototype.canRedo=function(){return 0!==this.redoStack.length},t.prototype.isUndoing=function(){return this.state===o},t.prototype.isRedoing=function(){return this.state===r},t}(),"object"==typeof module&&(module.exports=ot.UndoManager),void 0===ot&&(ot={}),ot.Client=function(){"use strict";function t(t){this.revision=t,this.setState(a)}function e(){}t.prototype.setState=function(t){this.state=t},t.prototype.applyClient=function(t){this.setState(this.state.applyClient(this,t))},t.prototype.applyServer=function(t,e){this.setState(this.state.applyServer(this,t,e))},t.prototype.applyOperations=function(t,e){this.setState(this.state.applyOperations(this,t,e))},t.prototype.serverAck=function(t){this.setState(this.state.serverAck(this,t))},t.prototype.serverReconnect=function(){"function"==typeof this.state.resend&&this.state.resend(this)},t.prototype.transformSelection=function(t){return this.state.transformSelection(t)},t.prototype.sendOperation=function(t,e){throw new Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(t){throw new Error("applyOperation must be defined in child class")},(t.Synchronized=e).prototype.applyClient=function(t,e){return t.sendOperation(t.revision,e),new h(e)},e.prototype.applyServer=function(t,e,n){if(1<e-t.revision)throw new Error("Invalid revision.");return t.revision=e,t.applyOperation(n),this},e.prototype.serverAck=function(t,e){throw new Error("There is no pending operation.")},e.prototype.transformSelection=function(t){return t};var a=new e;function h(t){this.outstanding=t}function s(t,e){this.outstanding=t,this.buffer=e}function n(t,e,n){this.acknowlaged=t,this.client=e,this.revision=n}function o(t,e,n,o){this.acknowlaged=t,this.buffer=e,this.client=n,this.revision=o}return(t.AwaitingConfirm=h).prototype.applyClient=function(t,e){return new s(this.outstanding,e)},h.prototype.applyServer=function(t,e,n){if(1<e-t.revision)throw new Error("Invalid revision.");t.revision=e;var o=n.constructor.transform(this.outstanding,n);return t.applyOperation(o[1]),new h(o[0])},h.prototype.serverAck=function(t,e){return 1<e-t.revision?new n(this.outstanding,t,e).getOperations():(t.revision=e,a)},h.prototype.transformSelection=function(t){return t.transform(this.outstanding)},h.prototype.resend=function(t){t.sendOperation(t.revision,this.outstanding)},(t.AwaitingWithBuffer=s).prototype.applyClient=function(t,e){var n=this.buffer.compose(e);return new s(this.outstanding,n)},s.prototype.applyServer=function(t,e,n){if(1<e-t.revision)throw new Error("Invalid revision.");t.revision=e;var o=n.constructor.transform,r=o(this.outstanding,n),i=o(this.buffer,r[1]);return t.applyOperation(i[1]),new s(r[0],i[0])},s.prototype.serverAck=function(t,e){return 1<e-t.revision?new o(this.outstanding,this.buffer,t,e).getOperations():(t.revision=e,t.sendOperation(t.revision,this.buffer),new h(this.buffer))},s.prototype.transformSelection=function(t){return t.transform(this.outstanding).transform(this.buffer)},s.prototype.resend=function(t){t.sendOperation(t.revision,this.outstanding)},(t.Stale=n).prototype.applyClient=function(t,e){return new o(this.acknowlaged,e,t,this.revision)},n.prototype.applyServer=function(t,e,n){throw new Error("Ignored server-side change.")},n.prototype.applyOperations=function(t,e,n){for(var o=this.acknowlaged.constructor.transform,r=0;r<n.length;r++){var i=ot.TextOperation.fromJSON(n[r]),s=o(this.acknowlaged,i);t.applyOperation(s[1]),this.acknowlaged=s[0]}return t.revision=this.revision,a},n.prototype.serverAck=function(t,e){throw new Error("There is no pending operation.")},n.prototype.transformSelection=function(t){return t},n.prototype.getOperations=function(){return this.client.getOperations(this.client.revision,this.revision-1),this},(t.StaleWithBuffer=o).prototype.applyClient=function(t,e){var n=this.buffer.compose(e);return new o(this.acknowlaged,n,t,this.revision)},o.prototype.applyServer=function(t,e,n){throw new Error("Ignored server-side change.")},o.prototype.applyOperations=function(t,e,n){for(var o=this.acknowlaged.constructor.transform,r=0;r<n.length;r++){var i=ot.TextOperation.fromJSON(n[r]),s=o(this.acknowlaged,i),a=o(this.buffer,s[1]);t.applyOperation(a[1]),this.acknowlaged=s[0],this.buffer=a[0]}return t.revision=this.revision,t.sendOperation(t.revision,this.buffer),new h(this.buffer)},o.prototype.serverAck=function(t,e){throw new Error("There is no pending operation.")},o.prototype.transformSelection=function(t){return t},o.prototype.getOperations=function(){return this.client.getOperations(this.client.revision,this.revision-1),this},t}(),"object"==typeof module&&(module.exports=ot.Client),ot.CodeMirrorAdapter=function(){"use strict";var u=ot.TextOperation,r=ot.Selection;function o(t){this.cm=t,this.ignoreNextChange=!1,this.changeInProgress=!1,this.selectionChanged=!1,e(this,"onChanges"),e(this,"onChange"),e(this,"onCursorActivity"),e(this,"onFocus"),e(this,"onBlur"),t.on("changes",this.onChanges),t.on("change",this.onChange),t.on("cursorActivity",this.onCursorActivity),t.on("focus",this.onFocus),t.on("blur",this.onBlur)}function n(t,e){return t.line<e.line?-1:t.line>e.line?1:t.ch<e.ch?-1:t.ch>e.ch?1:0}function f(t,e){return n(t,e)<=0}o.prototype.detach=function(){this.cm.off("changes",this.onChanges),this.cm.off("change",this.onChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},o.operationFromCodeMirrorChange=o.operationFromCodeMirrorChanges=function(t,e){var n,o=(n=e).indexFromPos({line:n.lastLine(),ch:0})+n.getLine(n.lastLine()).length,r=(new u).retain(o),i=(new u).retain(o),s=function(t){return e.indexFromPos(t)};function a(t){if(0===t.length)return 0;for(var e=0,n=0;n<t.length;n++)e+=t[n].length;return e+t.length-1}for(var h=t.length-1;0<=h;h--){var p=t[h],c=(s=function(n,o){return function(t){return f(t,o.from)?n(t):f(o.to,t)?n({line:t.line+o.text.length-1-(o.to.line-o.from.line),ch:o.to.line<t.line?t.ch:o.text.length<=1?t.ch-(o.to.ch-o.from.ch)+a(o.text):t.ch-o.to.ch+(e=o.text)[e.length-1].length})+a(o.removed)-a(o.text):o.from.line===t.line?n(o.from)+t.ch-o.from.ch:n(o.from)+a(o.removed.slice(0,t.line-o.from.line))+1+t.ch;var e}}(s,p))(p.from),l=o-c-a(p.text),r=(new u).retain(c).delete(a(p.removed)).insert(p.text.join("\n")).retain(l).compose(r),i=i.compose((new u).retain(c).delete(a(p.text)).insert(p.removed.join("\n")).retain(l));o+=a(p.removed)-a(p.text)}return[r,i]},o.applyOperationToCodeMirror=function(p,c){c.operation(function(){for(var t=p.ops,e=0,n=0,o=t.length;n<o;n++){var r,i,s,a,h=t[n];u.isRetain(h)?e+=h:u.isInsert(h)?(r=c.getCursor(),i=c.posFromIndex(e),c.replaceRange(h,i,null,"ignoreHistory"),r.line===i.line&&r.ch===i.ch&&c.setCursor(r),e+=h.length):u.isDelete(h)&&(s=c.posFromIndex(e),a=c.posFromIndex(e-h),c.replaceRange("",s,a,"ignoreHistory"))}})},o.prototype.registerCallbacks=function(t){this.callbacks=t},o.prototype.onChange=function(){this.changeInProgress=!0},o.prototype.onChanges=function(t,e){var n;this.ignoreNextChange||(n=o.operationFromCodeMirrorChanges(e,this.cm),this.trigger("change",n[0],n[1])),this.selectionChanged&&this.trigger("selectionChange"),this.changeInProgress=!1,this.ignoreNextChange=!1},o.prototype.onCursorActivity=o.prototype.onFocus=function(){this.changeInProgress?this.selectionChanged=!0:this.trigger("selectionChange")},o.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},o.prototype.getValue=function(){return this.cm.getValue()},o.prototype.getSelection=function(){for(var t=this.cm,e=t.listSelections(),n=[],o=0;o<e.length;o++)n[o]=new r.Range(t.indexFromPos(e[o].anchor),t.indexFromPos(e[o].head));return new r(n)},o.prototype.setSelection=function(t){for(var e=[],n=0;t&&n<t.ranges.length;n++){var o=t.ranges[n];e[n]={anchor:this.cm.posFromIndex(o.anchor),head:this.cm.posFromIndex(o.head)}}this.cm.setSelections(e)};var g=function(){var e={},t=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(t);var n=t.sheet;return function(t){e[t]||(e[t]=!0,n.insertRule(t,(n.cssRules||n.rules).length))}}();function e(t,e){var n=t[e];t[e]=function(){n.apply(t,arguments)}}return o.prototype.setOtherCursor=function(t,e,n){var o=this.cm.posFromIndex(t),r=(this.cm.cursorCoords(o),document.createElement("span"));return r.className="other-client",r.style.display="none",r.setAttribute("data-clientid",n),this.cm.setBookmark(o,{widget:r,insertLeft:!0})},o.prototype.setOtherSelectionRange=function(t,e,n){var o=/^#([0-9a-fA-F]{6})$/.exec(e);if(!o)throw new Error("only six-digit hex colors are allowed.");var r="selection-"+o[1],i=function(t){"#"===t[0]&&(t=t.substr(1));if(3===t.length){var e=t;t="",e=/^([a-f0-9])([a-f0-9])([a-f0-9])$/i.exec(e).slice(1);for(var n=0;n<3;n++)t+=e[n]+e[n]}var o=/^([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})$/i.exec(t).slice(1);return{red:parseInt(o[0],16),green:parseInt(o[1],16),blue:parseInt(o[2],16)}}(e),s="."+r+" { background: rgba("+i.red+","+i.green+","+i.blue+",0.2); }";g(s);var a,h,p,c,l=this.cm.posFromIndex(t.anchor),u=this.cm.posFromIndex(t.head);return this.cm.markText(f(p=l,c=u)?p:c,f(a=l,h=u)?h:a,{className:r})},o.prototype.setOtherSelection=function(t,e,n){for(var o=[],r=0;r<t.ranges.length;r++){var i=t.ranges[r];i.isEmpty()||(o[r]=this.setOtherSelectionRange(i,e,n))}return{clear:function(){for(var t=0;t<o.length;t++)o[t]&&o[t].clear()}}},o.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),n=this.callbacks&&this.callbacks[t];n&&n.apply(this,e)},o.prototype.applyOperation=function(t){t.isNoop()||(this.ignoreNextChange=!0),o.applyOperationToCodeMirror(t,this.cm)},o.prototype.registerUndo=function(t){this.cm.undo=t},o.prototype.registerRedo=function(t){this.cm.redo=t},o}(),ot.SocketIOAdapter=function(){"use strict";function t(t){this.socket=t;var r=this;t.on("client_left",function(t){r.trigger("client_left",t)}).on("set_name",function(t,e){r.trigger("set_name",t,e)}).on("set_color",function(t,e){r.trigger("set_color",t,e)}).on("ack",function(t){r.trigger("ack",t)}).on("operation",function(t,e,n,o){r.trigger("operation",e,n),r.trigger("selection",t,o)}).on("operations",function(t,e){r.trigger("operations",t,e)}).on("selection",function(t,e){r.trigger("selection",t,e)}).on("reconnect",function(){r.trigger("reconnect")})}return t.prototype.sendOperation=function(t,e,n){this.socket.emit("operation",t,e,n)},t.prototype.sendSelection=function(t){this.socket.emit("selection",t)},t.prototype.getOperations=function(t,e){this.socket.emit("get_operations",t,e)},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),n=this.callbacks&&this.callbacks[t];n&&n.apply(this,e)},t}(),ot.AjaxAdapter=function(){"use strict";function t(t,e,n){"/"!==t[t.length-1]&&(t+="/"),this.path=t,this.ownUserName=e,this.majorRevision=n.major||0,this.minorRevision=n.minor||0,this.poll()}return t.prototype.renderRevisionPath=function(){return"revision/"+this.majorRevision+"-"+this.minorRevision},t.prototype.handleResponse=function(t){for(var e=t.operations,n=0;n<e.length;n++)e[n].user===this.ownUserName?this.trigger("ack"):this.trigger("operation",e[n].operation);0<e.length&&(this.majorRevision+=e.length,this.minorRevision=0);var o=t.events;if(o){for(n=0;n<o.length;n++){var r=o[n].user;if(r!==this.ownUserName)switch(o[n].event){case"joined":this.trigger("set_name",r,r);break;case"left":this.trigger("client_left",r);break;case"selection":this.trigger("selection",r,o[n].selection)}}this.minorRevision+=o.length}var i=t.users;i&&(delete i[this.ownUserName],this.trigger("clients",i)),t.revision&&(this.majorRevision=t.revision.major,this.minorRevision=t.revision.minor)},t.prototype.poll=function(){var e=this;$.ajax({url:this.path+this.renderRevisionPath(),type:"GET",dataType:"json",timeout:5e3,success:function(t){e.handleResponse(t),e.poll()},error:function(){setTimeout(function(){e.poll()},500)}})},t.prototype.sendOperation=function(t,e,n){if(t!==this.majorRevision)throw new Error("Revision numbers out of sync");var o=this;$.ajax({url:this.path+this.renderRevisionPath(),type:"POST",data:JSON.stringify({operation:e,selection:n}),contentType:"application/json",processData:!1,success:function(t){},error:function(){setTimeout(function(){o.sendOperation(t,e,n)},500)}})},t.prototype.sendSelection=function(t){$.ajax({url:this.path+this.renderRevisionPath()+"/selection",type:"POST",data:JSON.stringify(t),contentType:"application/json",processData:!1,timeout:1e3})},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),n=this.callbacks&&this.callbacks[t];n&&n.apply(this,e)},t}(),ot.EditorClient=function(){"use strict";var t,i=ot.Client,s=ot.Selection,a=ot.UndoManager,h=ot.TextOperation,p=ot.WrappedOperation;function c(t,e){this.selectionBefore=t,this.selectionAfter=e}function n(t,e,n,o,r,i){this.id=t,this.listEl=e,this.editorAdapter=n,this.name=o,this.color=r,this.li=document.createElement("li"),o&&(this.li.textContent=o,this.listEl.appendChild(this.li)),r?this.setForceColor(r):this.setColor(o?u(o):Math.random()),i&&this.updateSelection(i)}function e(t,e,n,o){i.call(this,t),this.serverAdapter=n,this.editorAdapter=o,this.undoManager=new a(200),this.time=Date.now(),this.initializeClientList(),this.initializeClients(e);var r=this;this.editorAdapter.registerCallbacks({change:function(t,e){r.onChange(t,e)},selectionChange:function(){r.onSelectionChange()},blur:function(){r.onBlur()}}),this.editorAdapter.registerUndo(function(){r.undo()}),this.editorAdapter.registerRedo(function(){r.redo()}),this.serverAdapter.registerCallbacks({client_left:function(t){r.onClientLeft(t)},set_name:function(t,e){r.getClientObject(t).setName(e)},set_color:function(t,e){r.getClientObject(t).setForceColor(e)},ack:function(t){r.serverAck(t)},operation:function(t,e){r.applyServer(t,h.fromJSON(e))},operations:function(t,e){r.applyOperations(t,e)},selection:function(t,e){e?r.getClientObject(t).updateSelection(r.transformSelection(s.fromJSON(e))):r.getClientObject(t).removeSelection()},clients:function(t){var e,n,o;for(e in r.clients)r.clients.hasOwnProperty(e)&&!t.hasOwnProperty(e)&&r.onClientLeft(e);for(e in t){t.hasOwnProperty(e)&&(n=r.getClientObject(e),t[e].name&&n.setName(t[e].name),(o=t[e].selection)?r.clients[e].updateSelection(r.transformSelection(s.fromJSON(o))):r.clients[e].removeSelection())}},reconnect:function(){r.serverReconnect()}})}function o(){}function l(t,e,n){function o(t){var e=Math.round(255*t).toString(16);return 1===e.length?"0"+e:e}return"#"+o(t)+o(e)+o(n)}function r(t,e,n){if(0===e)return l(n,n,n);function o(t){return t<0&&(t+=1),1<t&&--t,6*t<1?i+6*(r-i)*t:2*t<1?r:3*t<2?i+6*(r-i)*(2/3-t):i}var r=n<.5?n*(1+e):n+e-e*n,i=2*n-r;return l(o(t+1/3),o(t),o(t-1/3))}function u(t){for(var e=1,n=0;n<t.length;n++)e=17*(e+t.charCodeAt(n))%360;return e/360}return c.prototype.invert=function(){return new c(this.selectionAfter,this.selectionBefore)},c.prototype.compose=function(t){return new c(this.selectionBefore,t.selectionAfter)},c.prototype.transform=function(t){return new c(this.selectionBefore?this.selectionBefore.transform(t):null,this.selectionAfter?this.selectionAfter.transform(t):null)},n.prototype.setColor=function(t){this.hue=t,this.color=r(t,.75,.5),this.lightColor=r(t,.5,.9),this.li&&(this.li.style.color=this.color)},n.prototype.setForceColor=function(t){this.hue=null,this.color=t,this.lightColor=t,this.li&&(this.li.style.color=this.color)},n.prototype.setName=function(t){this.name!==t&&(this.name=t,this.li.textContent=t,this.li.parentNode||this.listEl.appendChild(this.li),this.setColor(u(t)))},n.prototype.updateSelection=function(t){this.removeSelection(),this.selection=t,this.mark=this.editorAdapter.setOtherSelection(t,t.position===t.selectionEnd?this.color:this.lightColor,this.id)},n.prototype.remove=function(){var t;this.li&&(t=this.li).parentNode&&t.parentNode.removeChild(t),this.removeSelection()},n.prototype.removeSelection=function(){this.mark&&(this.mark.clear(),this.mark=null)},t=e,o.prototype=i.prototype,t.prototype=new o,t.prototype.constructor=t,e.prototype.addClient=function(t,e){this.clients[t]=new n(t,this.clientListEl,this.editorAdapter,e.name||t,e.color||null,e.selection?s.fromJSON(e.selection):null)},e.prototype.initializeClients=function(t){for(var e in this.clients={},t)t.hasOwnProperty(e)&&this.addClient(e,t[e])},e.prototype.getClientObject=function(t){var e=this.clients[t];return e||(this.clients[t]=new n(t,this.clientListEl,this.editorAdapter))},e.prototype.onClientLeft=function(t){var e=this.clients[t];e&&(e.remove(),delete this.clients[t])},e.prototype.initializeClientList=function(){this.clientListEl=document.createElement("ul")},e.prototype.applyUnredo=function(t){this.undoManager.add(t.invert(this.editorAdapter.getValue())),this.editorAdapter.applyOperation(t.wrapped),this.selection=t.meta.selectionAfter,this.editorAdapter.setSelection(this.selection),this.applyClient(t.wrapped)},e.prototype.undo=function(){var e=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(t){e.applyUnredo(t)})},e.prototype.redo=function(){var e=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(t){e.applyUnredo(t)})},e.prototype.onChange=function(t,e){var n=this.selection;this.updateSelection();var o,r=new c(n,this.selection),i=(new p(t,r),Date.now()),s=0<this.undoManager.undoStack.length&&e.shouldBeComposedWithInverted((o=this.undoManager.undoStack)[o.length-1].wrapped)&&i-this.time<1250,a=new c(this.selection,n);this.undoManager.add(new p(e,a),s),this.time=i,this.applyClient(t)},e.prototype.updateSelection=function(){this.selection=this.editorAdapter.getSelection()},e.prototype.onSelectionChange=function(){var t=this.selection;this.updateSelection(),t&&this.selection.equals(t)||this.sendSelection(this.selection)},e.prototype.onBlur=function(){this.selection=null,this.sendSelection(null)},e.prototype.sendSelection=function(t){this.state instanceof i.AwaitingWithBuffer||this.serverAdapter.sendSelection(t)},e.prototype.sendOperation=function(t,e){this.serverAdapter.sendOperation(t,e.toJSON(),this.selection)},e.prototype.getOperations=function(t,e){this.serverAdapter.getOperations(t,e)},e.prototype.applyOperation=function(t){this.editorAdapter.applyOperation(t),this.updateSelection(),this.undoManager.transform(new p(t,null))},e}();