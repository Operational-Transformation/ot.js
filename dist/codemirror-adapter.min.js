/*
 *    /\
 *   /  \ ot 0.0.15
 *  /    \ http://operational-transformation.github.com
 *  \    /
 *   \  / (c) 2012-2022 Tim Baumann <tim@timbaumann.info> (http://timbaumann.info)
 *    \/ ot may be freely distributed under the MIT license.
 */
ot.CodeMirrorAdapter=function(){"use strict";var p=ot.TextOperation,r=ot.Selection;function n(e){this.cm=e,this.ignoreNextChange=!1,this.changeInProgress=!1,this.selectionChanged=!1,h(this,"onChanges"),h(this,"onChange"),h(this,"onCursorActivity"),h(this,"onFocus"),h(this,"onBlur"),e.on("changes",this.onChanges),e.on("change",this.onChange),e.on("cursorActivity",this.onCursorActivity),e.on("focus",this.onFocus),e.on("blur",this.onBlur)}function o(e,t){return e.line<t.line?-1:e.line>t.line?1:e.ch<t.ch?-1:e.ch>t.ch?1:0}function m(e,t){return o(e,t)<=0}n.prototype.detach=function(){this.cm.off("changes",this.onChanges),this.cm.off("change",this.onChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},n.operationFromCodeMirrorChange=n.operationFromCodeMirrorChanges=function(e,t){var n,o=(n=t).indexFromPos({line:n.lastLine(),ch:0})+n.getLine(n.lastLine()).length,r=(new p).retain(o),i=(new p).retain(o),s=function(e){return t.indexFromPos(e)};function h(e){if(0===e.length)return 0;for(var t=0,n=0;n<e.length;n++)t+=e[n].length;return t+e.length-1}function c(n,o){return function(e){return m(e,o.from)?n(e):m(o.to,e)?n({line:e.line+o.text.length-1-(o.to.line-o.from.line),ch:o.to.line<e.line?e.ch:o.text.length<=1?e.ch-(o.to.ch-o.from.ch)+h(o.text):e.ch-o.to.ch+(t=o.text)[t.length-1].length})+h(o.removed)-h(o.text):o.from.line===e.line?n(o.from)+e.ch-o.from.ch:n(o.from)+h(o.removed.slice(0,e.line-o.from.line))+1+e.ch;var t}}for(var a=e.length-1;0<=a;a--){var l=e[a],g=(s=c(s,l))(l.from),u=o-g-h(l.text),r=(new p).retain(g).delete(h(l.removed)).insert(l.text.join("\n")).retain(u).compose(r),i=i.compose((new p).retain(g).delete(h(l.text)).insert(l.removed.join("\n")).retain(u));o+=h(l.removed)-h(l.text)}return[r,i]},n.applyOperationToCodeMirror=function(s,h){h.operation(function(){for(var e=s.ops,t=0,n=0,o=e.length;n<o;n++){var r,i=e[n];p.isRetain(i)?t+=i:p.isInsert(i)?(h.replaceRange(i,h.posFromIndex(t)),t+=i.length):p.isDelete(i)&&(r=h.posFromIndex(t),i=h.posFromIndex(t-i),h.replaceRange("",r,i))}})},n.prototype.registerCallbacks=function(e){this.callbacks=e},n.prototype.onChange=function(){this.changeInProgress=!0},n.prototype.onChanges=function(e,t){this.ignoreNextChange||(t=n.operationFromCodeMirrorChanges(t,this.cm),this.trigger("change",t[0],t[1])),this.selectionChanged&&this.trigger("selectionChange"),this.changeInProgress=!1,this.ignoreNextChange=!1},n.prototype.onCursorActivity=n.prototype.onFocus=function(){this.changeInProgress?this.selectionChanged=!0:this.trigger("selectionChange")},n.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},n.prototype.getValue=function(){return this.cm.getValue()},n.prototype.getSelection=function(){for(var e=this.cm,t=e.listSelections(),n=[],o=0;o<t.length;o++)n[o]=new r.Range(e.indexFromPos(t[o].anchor),e.indexFromPos(t[o].head));return new r(n)},n.prototype.setSelection=function(e){for(var t=[],n=0;n<e.ranges.length;n++){var o=e.ranges[n];t[n]={anchor:this.cm.posFromIndex(o.anchor),head:this.cm.posFromIndex(o.head)}}this.cm.setSelections(t)};t={},e=document.createElement("style"),document.documentElement.getElementsByTagName("head")[0].appendChild(e),i=e.sheet;var t,e,i,s=function(e){t[e]||(t[e]=!0,i.insertRule(e,(i.cssRules||i.rules).length))};function h(e,t){var n=e[t];e[t]=function(){n.apply(e,arguments)}}return n.prototype.setOtherCursor=function(e,t,n){var e=this.cm.posFromIndex(e),o=this.cm.cursorCoords(e),r=document.createElement("span");return r.className="other-client",r.style.display="inline-block",r.style.padding="0",r.style.marginLeft=r.style.marginRight="-1px",r.style.borderLeftWidth="2px",r.style.borderLeftStyle="solid",r.style.borderLeftColor=t,r.style.height=.9*(o.bottom-o.top)+"px",r.style.zIndex=0,r.setAttribute("data-clientid",n),this.cm.setBookmark(e,{widget:r,insertLeft:!0})},n.prototype.setOtherSelectionRange=function(e,t,n){var o=/^#([0-9a-fA-F]{6})$/.exec(t);if(!o)throw new Error("only six-digit hex colors are allowed.");var r,i,o="selection-"+o[1],t=(s("."+o+" { background: "+t+"; }"),this.cm.posFromIndex(e.anchor)),e=this.cm.posFromIndex(e.head);return this.cm.markText(m(r=t,i=e)?r:i,m(r=t,i=e)?i:r,{className:o})},n.prototype.setOtherSelection=function(e,t,n){for(var o=[],r=0;r<e.ranges.length;r++){var i=e.ranges[r];i.isEmpty()?o[r]=this.setOtherCursor(i.head,t,n):o[r]=this.setOtherSelectionRange(i,t,n)}return{clear:function(){for(var e=0;e<o.length;e++)o[e].clear()}}},n.prototype.trigger=function(e){var t=Array.prototype.slice.call(arguments,1),e=this.callbacks&&this.callbacks[e];e&&e.apply(this,t)},n.prototype.applyOperation=function(e){e.isNoop()||(this.ignoreNextChange=!0),n.applyOperationToCodeMirror(e,this.cm)},n.prototype.registerUndo=function(e){this.cm.undo=e},n.prototype.registerRedo=function(e){this.cm.redo=e},n}();