/*
 *    /\
 *   /  \ ot 0.0.15
 *  /    \ http://operational-transformation.github.com
 *  \    /
 *   \  / (c) 2012-2022 Tim Baumann <tim@timbaumann.info> (http://timbaumann.info)
 *    \/ ot may be freely distributed under the MIT license.
 */
var ot;(ot=void 0===ot?{}:ot).TextOperation=function(){"use strict";function l(){if(!this||this.constructor!==l)return new l;this.ops=[],this.baseLength=0,this.targetLength=0}l.prototype.equals=function(t){if(this.baseLength!==t.baseLength)return!1;if(this.targetLength!==t.targetLength)return!1;if(this.ops.length!==t.ops.length)return!1;for(var e=0;e<this.ops.length;e++)if(this.ops[e]!==t.ops[e])return!1;return!0};var u=l.isRetain=function(t){return"number"==typeof t&&0<t},f=l.isInsert=function(t){return"string"==typeof t},d=l.isDelete=function(t){return"number"==typeof t&&t<0};function i(t){var e=t.ops,n=l.isRetain;switch(e.length){case 1:return e[0];case 2:return n(e[0])?e[1]:n(e[1])?e[0]:null;case 3:if(n(e[0])&&n(e[2]))return e[1]}return null}function r(t){return u(t.ops[0])?t.ops[0]:0}return l.prototype.retain=function(t){if("number"!=typeof t)throw new Error("retain expects an integer");return 0===t||(this.baseLength+=t,this.targetLength+=t,u(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=t:this.ops.push(t)),this},l.prototype.insert=function(t){if("string"!=typeof t)throw new Error("insert expects a string");if(""===t)return this;this.targetLength+=t.length;var e=this.ops;return f(e[e.length-1])?e[e.length-1]+=t:d(e[e.length-1])?f(e[e.length-2])?e[e.length-2]+=t:(e[e.length]=e[e.length-1],e[e.length-2]=t):e.push(t),this},l.prototype.delete=function(t){if("number"!=typeof(t="string"==typeof t?t.length:t))throw new Error("delete expects an integer or a string");return 0===t||(this.baseLength-=t=0<t?-t:t,d(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=t:this.ops.push(t)),this},l.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&u(this.ops[0])},l.prototype.toString=function(){return(Array.prototype.map||function(t){for(var e=[],n=0,o=this.length;n<o;n++)e[n]=t(this[n]);return e}).call(this.ops,function(t){return u(t)?"retain "+t:f(t)?"insert '"+t+"'":"delete "+-t}).join(", ")},l.prototype.toJSON=function(){return this.ops},l.fromJSON=function(t){for(var e=new l,n=0,o=t.length;n<o;n++){var i=t[n];if(u(i))e.retain(i);else if(f(i))e.insert(i);else{if(!d(i))throw new Error("unknown operation: "+JSON.stringify(i));e.delete(i)}}return e},l.prototype.apply=function(t){if(t.length!==this.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var e=[],n=0,o=0,i=this.ops,r=0,s=i.length;r<s;r++){var a=i[r];if(u(a)){if(o+a>t.length)throw new Error("Operation can't retain more characters than are left in the string.");e[n++]=t.slice(o,o+a),o+=a}else f(a)?e[n++]=a:o-=a}if(o!==t.length)throw new Error("The operation didn't operate on the whole string.");return e.join("")},l.prototype.invert=function(t){for(var e=0,n=new l,o=this.ops,i=0,r=o.length;i<r;i++){var s=o[i];u(s)?(n.retain(s),e+=s):f(s)?n.delete(s.length):(n.insert(t.slice(e,e-s)),e-=s)}return n},l.prototype.compose=function(t){if(this.targetLength!==t.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");for(var e=new l,n=this.ops,o=t.ops,i=0,r=0,s=n[i++],a=o[r++];void 0!==s||void 0!==a;)if(d(s))e.delete(s),s=n[i++];else if(f(a))e.insert(a),a=o[r++];else{if(void 0===s)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===a)throw new Error("Cannot compose operations: first operation is too long.");if(u(s)&&u(a))a<s?(e.retain(a),s-=a,a=o[r++]):s===a?(e.retain(s),s=n[i++],a=o[r++]):(e.retain(s),a-=s,s=n[i++]);else if(f(s)&&d(a))s.length>-a?(s=s.slice(-a),a=o[r++]):s.length===-a?(s=n[i++],a=o[r++]):(a+=s.length,s=n[i++]);else if(f(s)&&u(a))s.length>a?(e.insert(s.slice(0,a)),s=s.slice(a),a=o[r++]):s.length===a?(e.insert(s),s=n[i++],a=o[r++]):(e.insert(s),a-=s.length,s=n[i++]);else{if(!u(s)||!d(a))throw new Error("This shouldn't happen: op1: "+JSON.stringify(s)+", op2: "+JSON.stringify(a));-a<s?(e.delete(a),s+=a,a=o[r++]):s===-a?(e.delete(a),s=n[i++],a=o[r++]):(e.delete(s),a+=s,s=n[i++])}}return e},l.prototype.shouldBeComposedWith=function(t){if(this.isNoop()||t.isNoop())return!0;var e=r(this),n=r(t),o=i(this),t=i(t);return!(!o||!t)&&(f(o)&&f(t)?e+o.length===n:!(!d(o)||!d(t))&&(n-t===e||e===n))},l.prototype.shouldBeComposedWithInverted=function(t){if(this.isNoop()||t.isNoop())return!0;var e=r(this),n=r(t),o=i(this),t=i(t);return!(!o||!t)&&(f(o)&&f(t)?e+o.length===n||e===n:!(!d(o)||!d(t))&&n-t===e)},l.transform=function(t,e){if(t.baseLength!==e.baseLength)throw new Error("Both operations have to have the same base length");for(var n,o=new l,i=new l,r=t.ops,s=e.ops,a=0,p=0,h=r[a++],c=s[p++];void 0!==h||void 0!==c;)if(f(h))o.insert(h),i.retain(h.length),h=r[a++];else if(f(c))o.retain(c.length),i.insert(c),c=s[p++];else{if(void 0===h)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===c)throw new Error("Cannot compose operations: first operation is too long.");if(u(h)&&u(c))c<h?(h-=n=c,c=s[p++]):h===c?(n=c,h=r[a++],c=s[p++]):(c-=n=h,h=r[a++]),o.retain(n),i.retain(n);else if(d(h)&&d(c))-c<-h?(h-=c,c=s[p++]):h===c?(h=r[a++],c=s[p++]):(c-=h,h=r[a++]);else if(d(h)&&u(c))c<-h?(h+=n=c,c=s[p++]):-h===c?(n=c,h=r[a++],c=s[p++]):(n=-h,c+=h,h=r[a++]),o.delete(n);else{if(!u(h)||!d(c))throw new Error("The two operations aren't compatible");-c<h?(n=-c,h+=c,c=s[p++]):h===-c?(n=h,h=r[a++],c=s[p++]):(c+=n=h,h=r[a++]),i.delete(n)}}return[o,i]},l}(),"object"==typeof module&&(module.exports=ot.TextOperation),(ot=void 0===ot?{}:ot).Selection=function(t){"use strict";var s=t.ot?t.ot.TextOperation:require("./text-operation");function i(t,e){this.anchor=t,this.head=e}function r(t){this.ranges=t||[]}return i.fromJSON=function(t){return new i(t.anchor,t.head)},i.prototype.equals=function(t){return this.anchor===t.anchor&&this.head===t.head},i.prototype.isEmpty=function(){return this.anchor===this.head},i.prototype.transform=function(r){function t(t){for(var e=t,n=r.ops,o=0,i=r.ops.length;o<i&&(s.isRetain(n[o])?t-=n[o]:s.isInsert(n[o])?e+=n[o].length:(e-=Math.min(t,-n[o]),t+=n[o]),!(t<0));o++);return e}var e=t(this.anchor);return this.anchor===this.head?new i(e,e):new i(e,t(this.head))},r.Range=i,r.createCursor=function(t){return new r([new i(t,t)])},r.fromJSON=function(t){for(var e=t.ranges||t,n=0,o=[];n<e.length;n++)o[n]=i.fromJSON(e[n]);return new r(o)},r.prototype.equals=function(t){if(this.position!==t.position)return!1;if(this.ranges.length!==t.ranges.length)return!1;for(var e=0;e<this.ranges.length;e++)if(!this.ranges[e].equals(t.ranges[e]))return!1;return!0},r.prototype.somethingSelected=function(){for(var t=0;t<this.ranges.length;t++)if(!this.ranges[t].isEmpty())return!0;return!1},r.prototype.compose=function(t){return t},r.prototype.transform=function(t){for(var e=0,n=[];e<this.ranges.length;e++)n[e]=this.ranges[e].transform(t);return new r(n)},r}(this),"object"==typeof module&&(module.exports=ot.Selection),(ot=void 0===ot?{}:ot).WrappedOperation=function(){"use strict";function o(t,e){this.wrapped=t,this.meta=e}function i(t,e){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}function r(t,e){return t&&"object"==typeof t&&"function"==typeof t.transform?t.transform(e):t}return o.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},o.prototype.invert=function(){var t=this.meta;return new o(this.wrapped.invert.apply(this.wrapped,arguments),t&&"object"==typeof t&&"function"==typeof t.invert?t.invert.apply(t,arguments):t)},o.prototype.compose=function(t){return new o(this.wrapped.compose(t.wrapped),function(t,e){if(t&&"object"==typeof t){if("function"==typeof t.compose)return t.compose(e);var n={};return i(t,n),i(e,n),n}return e}(this.meta,t.meta))},o.transform=function(t,e){var n=(0,t.wrapped.constructor.transform)(t.wrapped,e.wrapped);return[new o(n[0],r(t.meta,e.wrapped)),new o(n[1],r(e.meta,t.wrapped))]},o}(),"object"==typeof module&&(module.exports=ot.WrappedOperation),(ot=void 0===ot?{}:ot).UndoManager=function(){"use strict";var e="normal",o="undoing",i="redoing";function t(t){this.maxItems=t||50,this.state=e,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function n(t,e){for(var n=[],o=e.constructor,i=t.length-1;0<=i;i--){var r=o.transform(t[i],e);"function"==typeof r[0].isNoop&&r[0].isNoop()||n.push(r[0]),e=r[1]}return n.reverse()}return t.prototype.add=function(t,e){var n;this.state===o?(this.redoStack.push(t),this.dontCompose=!0):this.state===i?(this.undoStack.push(t),this.dontCompose=!0):(n=this.undoStack,!this.dontCompose&&e&&0<n.length?n.push(t.compose(n.pop())):(n.push(t),n.length>this.maxItems&&n.shift()),this.dontCompose=!1,this.redoStack=[])},t.prototype.transform=function(t){this.undoStack=n(this.undoStack,t),this.redoStack=n(this.redoStack,t)},t.prototype.performUndo=function(t){if(this.state=o,0===this.undoStack.length)throw new Error("undo not possible");t(this.undoStack.pop()),this.state=e},t.prototype.performRedo=function(t){if(this.state=i,0===this.redoStack.length)throw new Error("redo not possible");t(this.redoStack.pop()),this.state=e},t.prototype.canUndo=function(){return 0!==this.undoStack.length},t.prototype.canRedo=function(){return 0!==this.redoStack.length},t.prototype.isUndoing=function(){return this.state===o},t.prototype.isRedoing=function(){return this.state===i},t}(),"object"==typeof module&&(module.exports=ot.UndoManager),(ot=void 0===ot?{}:ot).Client=function(){"use strict";function t(t){this.revision=t,this.state=n}function e(){}t.prototype.setState=function(t){this.state=t},t.prototype.applyClient=function(t){this.setState(this.state.applyClient(this,t))},t.prototype.applyServer=function(t){this.revision++,this.setState(this.state.applyServer(this,t))},t.prototype.serverAck=function(){this.revision++,this.setState(this.state.serverAck(this))},t.prototype.serverReconnect=function(){"function"==typeof this.state.resend&&this.state.resend(this)},t.prototype.transformSelection=function(t){return this.state.transformSelection(t)},t.prototype.sendOperation=function(t,e){throw new Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(t){throw new Error("applyOperation must be defined in child class")},(t.Synchronized=e).prototype.applyClient=function(t,e){return t.sendOperation(t.revision,e),new o(e)},e.prototype.applyServer=function(t,e){return t.applyOperation(e),this},e.prototype.serverAck=function(t){throw new Error("There is no pending operation.")},e.prototype.transformSelection=function(t){return t};var n=new e;function o(t){this.outstanding=t}function i(t,e){this.outstanding=t,this.buffer=e}return(t.AwaitingConfirm=o).prototype.applyClient=function(t,e){return new i(this.outstanding,e)},o.prototype.applyServer=function(t,e){e=e.constructor.transform(this.outstanding,e);return t.applyOperation(e[1]),new o(e[0])},o.prototype.serverAck=function(t){return n},o.prototype.transformSelection=function(t){return t.transform(this.outstanding)},o.prototype.resend=function(t){t.sendOperation(t.revision,this.outstanding)},(t.AwaitingWithBuffer=i).prototype.applyClient=function(t,e){e=this.buffer.compose(e);return new i(this.outstanding,e)},i.prototype.applyServer=function(t,e){var n=e.constructor.transform,e=n(this.outstanding,e),n=n(this.buffer,e[1]);return t.applyOperation(n[1]),new i(e[0],n[0])},i.prototype.serverAck=function(t){return t.sendOperation(t.revision,this.buffer),new o(this.buffer)},i.prototype.transformSelection=function(t){return t.transform(this.outstanding).transform(this.buffer)},i.prototype.resend=function(t){t.sendOperation(t.revision,this.outstanding)},t}(),"object"==typeof module&&(module.exports=ot.Client),ot.SocketIOAdapter=function(){"use strict";function t(t){this.socket=t;var o=this;t.on("client_left",function(t){o.trigger("client_left",t)}).on("set_name",function(t,e){o.trigger("set_name",t,e)}).on("ack",function(){o.trigger("ack")}).on("operation",function(t,e,n){o.trigger("operation",e),o.trigger("selection",t,n)}).on("selection",function(t,e){o.trigger("selection",t,e)}).on("reconnect",function(){o.trigger("reconnect")})}return t.prototype.sendOperation=function(t,e,n){this.socket.emit("operation",t,e,n)},t.prototype.sendSelection=function(t){this.socket.emit("selection",t)},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),t=this.callbacks&&this.callbacks[t];t&&t.apply(this,e)},t}(),ot.AjaxAdapter=function(){"use strict";function t(t,e,n){"/"!==t[t.length-1]&&(t+="/"),this.path=t,this.ownUserName=e,this.majorRevision=n.major||0,this.minorRevision=n.minor||0,this.poll()}return t.prototype.renderRevisionPath=function(){return"revision/"+this.majorRevision+"-"+this.minorRevision},t.prototype.handleResponse=function(t){for(var e=t.operations,n=0;n<e.length;n++)e[n].user===this.ownUserName?this.trigger("ack"):this.trigger("operation",e[n].operation);0<e.length&&(this.majorRevision+=e.length,this.minorRevision=0);var o=t.events;if(o){for(n=0;n<o.length;n++){var i=o[n].user;if(i!==this.ownUserName)switch(o[n].event){case"joined":this.trigger("set_name",i,i);break;case"left":this.trigger("client_left",i);break;case"selection":this.trigger("selection",i,o[n].selection)}}this.minorRevision+=o.length}var r=t.users;r&&(delete r[this.ownUserName],this.trigger("clients",r)),t.revision&&(this.majorRevision=t.revision.major,this.minorRevision=t.revision.minor)},t.prototype.poll=function(){var e=this;$.ajax({url:this.path+this.renderRevisionPath(),type:"GET",dataType:"json",timeout:5e3,success:function(t){e.handleResponse(t),e.poll()},error:function(){setTimeout(function(){e.poll()},500)}})},t.prototype.sendOperation=function(t,e,n){if(t!==this.majorRevision)throw new Error("Revision numbers out of sync");var o=this;$.ajax({url:this.path+this.renderRevisionPath(),type:"POST",data:JSON.stringify({operation:e,selection:n}),contentType:"application/json",processData:!1,success:function(t){},error:function(){setTimeout(function(){o.sendOperation(t,e,n)},500)}})},t.prototype.sendSelection=function(t){$.ajax({url:this.path+this.renderRevisionPath()+"/selection",type:"POST",data:JSON.stringify(t),contentType:"application/json",processData:!1,timeout:1e3})},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),t=this.callbacks&&this.callbacks[t];t&&t.apply(this,e)},t}(),ot.EditorClient=function(){"use strict";var t,r=ot.Client,s=ot.Selection,a=ot.UndoManager,p=ot.TextOperation,i=ot.WrappedOperation;function h(t,e){this.selectionBefore=t,this.selectionAfter=e}function n(t,e,n,o,i){this.id=t,this.listEl=e,this.editorAdapter=n,this.name=o,this.li=document.createElement("li"),o&&(this.li.textContent=o,this.listEl.appendChild(this.li)),this.setColor(o?u(o):Math.random()),i&&this.updateSelection(i)}function e(t,e,n,o){r.call(this,t),this.serverAdapter=n,this.editorAdapter=o,this.undoManager=new a,this.initializeClientList(),this.initializeClients(e);var i=this;this.editorAdapter.registerCallbacks({change:function(t,e){i.onChange(t,e)},selectionChange:function(){i.onSelectionChange()},blur:function(){i.onBlur()}}),this.editorAdapter.registerUndo(function(){i.undo()}),this.editorAdapter.registerRedo(function(){i.redo()}),this.serverAdapter.registerCallbacks({client_left:function(t){i.onClientLeft(t)},set_name:function(t,e){i.getClientObject(t).setName(e)},ack:function(){i.serverAck()},operation:function(t){i.applyServer(p.fromJSON(t))},selection:function(t,e){e?i.getClientObject(t).updateSelection(i.transformSelection(s.fromJSON(e))):i.getClientObject(t).removeSelection()},clients:function(t){var e,n;for(e in i.clients)i.clients.hasOwnProperty(e)&&!t.hasOwnProperty(e)&&i.onClientLeft(e);for(e in t)t.hasOwnProperty(e)&&(n=i.getClientObject(e),t[e].name&&n.setName(t[e].name),(n=t[e].selection)?i.clients[e].updateSelection(i.transformSelection(s.fromJSON(n))):i.clients[e].removeSelection())},reconnect:function(){i.serverReconnect()}})}function o(){}function c(t,e,n){function o(t){t=Math.round(255*t).toString(16);return 1===t.length?"0"+t:t}return"#"+o(t)+o(e)+o(n)}function l(t,e,n){if(0===e)return c(n,n,n);function o(t){return t<0&&(t+=1),1<t&&--t,6*t<1?r+6*(i-r)*t:2*t<1?i:3*t<2?r+6*(i-r)*(2/3-t):r}var i=n<.5?n*(1+e):n+e-e*n,r=2*n-i;return c(o(t+1/3),o(t),o(t-1/3))}function u(t){for(var e=1,n=0;n<t.length;n++)e=17*(e+t.charCodeAt(n))%360;return e/360}return h.prototype.invert=function(){return new h(this.selectionAfter,this.selectionBefore)},h.prototype.compose=function(t){return new h(this.selectionBefore,t.selectionAfter)},h.prototype.transform=function(t){return new h(this.selectionBefore.transform(t),this.selectionAfter.transform(t))},n.prototype.setColor=function(t){this.hue=t,this.color=l(t,.75,.5),this.lightColor=l(t,.5,.9),this.li&&(this.li.style.color=this.color)},n.prototype.setName=function(t){this.name!==t&&(this.name=t,this.li.textContent=t,this.li.parentNode||this.listEl.appendChild(this.li),this.setColor(u(t)))},n.prototype.updateSelection=function(t){this.removeSelection(),this.selection=t,this.mark=this.editorAdapter.setOtherSelection(t,t.position===t.selectionEnd?this.color:this.lightColor,this.id)},n.prototype.remove=function(){var t;this.li&&(t=this.li).parentNode&&t.parentNode.removeChild(t),this.removeSelection()},n.prototype.removeSelection=function(){this.mark&&(this.mark.clear(),this.mark=null)},t=e,o.prototype=r.prototype,t.prototype=new o,t.prototype.constructor=t,e.prototype.addClient=function(t,e){this.clients[t]=new n(t,this.clientListEl,this.editorAdapter,e.name||t,e.selection?s.fromJSON(e.selection):null)},e.prototype.initializeClients=function(t){for(var e in this.clients={},t)t.hasOwnProperty(e)&&this.addClient(e,t[e])},e.prototype.getClientObject=function(t){var e=this.clients[t];return e||(this.clients[t]=new n(t,this.clientListEl,this.editorAdapter))},e.prototype.onClientLeft=function(t){console.log("User disconnected: "+t);var e=this.clients[t];e&&(e.remove(),delete this.clients[t])},e.prototype.initializeClientList=function(){this.clientListEl=document.createElement("ul")},e.prototype.applyUnredo=function(t){this.undoManager.add(t.invert(this.editorAdapter.getValue())),this.editorAdapter.applyOperation(t.wrapped),this.selection=t.meta.selectionAfter,this.editorAdapter.setSelection(this.selection),this.applyClient(t.wrapped)},e.prototype.undo=function(){var e=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(t){e.applyUnredo(t)})},e.prototype.redo=function(){var e=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(t){e.applyUnredo(t)})},e.prototype.onChange=function(t,e){var n=this.selection,o=(this.updateSelection(),new h(n,this.selection)),o=(new i(t,o),0<this.undoManager.undoStack.length&&e.shouldBeComposedWithInverted((o=this.undoManager.undoStack)[o.length-1].wrapped)),n=new h(this.selection,n);this.undoManager.add(new i(e,n),o),this.applyClient(t)},e.prototype.updateSelection=function(){this.selection=this.editorAdapter.getSelection()},e.prototype.onSelectionChange=function(){var t=this.selection;this.updateSelection(),t&&this.selection.equals(t)||this.sendSelection(this.selection)},e.prototype.onBlur=function(){this.selection=null,this.sendSelection(null)},e.prototype.sendSelection=function(t){this.state instanceof r.AwaitingWithBuffer||this.serverAdapter.sendSelection(t)},e.prototype.sendOperation=function(t,e){this.serverAdapter.sendOperation(t,e.toJSON(),this.selection)},e.prototype.applyOperation=function(t){this.editorAdapter.applyOperation(t),this.updateSelection(),this.undoManager.transform(new i(t,null))},e}();