/*
 *    /\
 *   /  \ ot 0.0.10
 *  /    \ http://operational-transformation.github.com
 *  \    /
 *   \  / (c) 2012 Tim Baumann <tim@timbaumann.info> (http://timbaumann.info)
 *    \/ ot may be freely distributed under the MIT license.
 */
if(typeof ot=="undefined")var ot={};ot.TextOperation=function(){function a(){if(this.constructor!==a)return new a;this.ops=[],this.baseLength=0,this.targetLength=0}a.prototype.equals=function(a){if(this.baseLength!==a.baseLength)return!1;if(this.targetLength!==a.targetLength)return!1;if(this.ops.length!==a.ops.length)return!1;for(var b=0;b<this.ops.length;b++)if(this.ops[b]!==a.ops[b])return!1;return!0};var b=a.isRetain=function(a){return typeof a=="number"&&a>0},c=a.isInsert=function(a){return typeof a=="string"},d=a.isDelete=function(a){return typeof a=="number"&&a<0};return a.prototype.retain=function(a){if(typeof a!="number")throw new Error("retain expects an integer");return a===0?this:(this.baseLength+=a,this.targetLength+=a,b(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=a:this.ops.push(a),this)},a.prototype.insert=function(a){if(typeof a!="string")throw new Error("insert expects a string");if(a==="")return this;this.targetLength+=a.length;var b=this.ops;return c(b[b.length-1])?b[b.length-1]+=a:d(b[b.length-1])?c(b[b.length-2])?b[b.length-2]+=a:(b[b.length]=b[b.length-1],b[b.length-2]=a):b.push(a),this},a.prototype["delete"]=function(a){typeof a=="string"&&(a=a.length);if(typeof a!="number")throw new Error("delete expects an integer or a string");return a===0?this:(a>0&&(a=-a),this.baseLength-=a,d(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=a:this.ops.push(a),this)},a.prototype.isNoop=function(){return this.ops.length===0||this.ops.length===1&&b(this.ops[0])},a.prototype.toString=function(){var a=Array.prototype.map||function(a){var b=this,c=[];for(var d=0,e=b.length;d<e;d++)c[d]=a(b[d]);return c};return a.call(this.ops,function(a){return b(a)?"retain "+a:c(a)?"insert '"+a+"'":"delete "+ -a}).join(", ")},a.prototype.toJSON=function(){return this.ops},a.fromJSON=function(e){var f=new a;for(var g=0,h=e.length;g<h;g++){var i=e[g];if(b(i))f.retain(i);else if(c(i))f.insert(i);else if(d(i))f["delete"](i);else throw new Error("unknown operation: "+JSON.stringify(i))}return f},a.prototype.apply=function(a){var d=this;if(a.length!==d.baseLength)throw new Error("The operation's base length must be equal to the string's length.");var e=[],f=0,g=0,h=this.ops;for(var i=0,j=h.length;i<j;i++){var k=h[i];if(b(k)){if(g+k>a.length)throw new Error("Operation can't retain more characters than are left in the string.");e[f++]=a.slice(g,g+k),g+=k}else c(k)?e[f++]=k:g-=k}if(g!==a.length)throw new Error("The operation didn't operate on the whole string.");return e.join("")},a.prototype.invert=function(d){var e=0,f=new a,g=this.ops;for(var h=0,i=g.length;h<i;h++){var j=g[h];b(j)?(f.retain(j),e+=j):c(j)?f["delete"](j.length):(f.insert(d.slice(e,e-j)),e-=j)}return f},a.prototype.compose=function(e){var f=this;if(f.targetLength!==e.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");var g=new a,h=f.ops,i=e.ops,j=0,k=0,l=h[j++],m=i[k++];for(;;){if(typeof l=="undefined"&&typeof m=="undefined")break;if(d(l)){g["delete"](l),l=h[j++];continue}if(c(m)){g.insert(m),m=i[k++];continue}if(typeof l=="undefined")throw new Error("Cannot compose operations: first operation is too short.");if(typeof m=="undefined")throw new Error("Cannot compose operations: fist operation is too long.");if(b(l)&&b(m))l>m?(g.retain(m),l=l-m,m=i[k++]):l===m?(g.retain(l),l=h[j++],m=i[k++]):(g.retain(l),m=m-l,l=h[j++]);else if(c(l)&&d(m))l.length>-m?(l=l.slice(-m),m=i[k++]):l.length===-m?(l=h[j++],m=i[k++]):(m=m+l.length,l=h[j++]);else if(c(l)&&b(m))l.length>m?(g.insert(l.slice(0,m)),l=l.slice(m),m=i[k++]):l.length===m?(g.insert(l),l=h[j++],m=i[k++]):(g.insert(l),m=m-l.length,l=h[j++]);else if(b(l)&&d(m))l>-m?(g["delete"](m),l=l+m,m=i[k++]):l===-m?(g["delete"](m),l=h[j++],m=i[k++]):(g["delete"](l),m=m+l,l=h[j++]);else throw new Error("This shouldn't happen: op1: "+JSON.stringify(l)+", op2: "+JSON.stringify(m))}return g},a.prototype.shouldBeComposedWith=function(e){function f(b,c){var d=b.ops,e=a.isRetain;switch(d.length){case 1:return d[0];case 2:return e(d[0])?d[1]:e(d[1])?d[0]:null;case 3:if(e(d[0])&&e(d[2]))return d[1]}return null}function g(a){return b(a.ops[0])?a.ops[0]:0}if(this.isNoop()||e.isNoop())return!0;var h=g(this),i=g(e),j=f(this),k=f(e);return!j||!k?!1:c(j)&&c(k)?h+j.length===i:d(j)&&d(k)?i-k===h||h===i:!1},a.transform=function(e,f){if(e.baseLength!==f.baseLength)throw new Error("Both operations have to have the same base length");var g=new a,h=new a,i=e.ops,j=f.ops,k=0,l=0,m=i[k++],n=j[l++];for(;;){if(typeof m=="undefined"&&typeof n=="undefined")break;if(c(m)){g.insert(m),h.retain(m.length),m=i[k++];continue}if(c(n)){g.retain(n.length),h.insert(n),n=j[l++];continue}if(typeof m=="undefined")throw new Error("Cannot compose operations: first operation is too short.");if(typeof n=="undefined")throw new Error("Cannot compose operations: first operation is too long.");var o;if(b(m)&&b(n))m>n?(o=n,m=m-n,n=j[l++]):m===n?(o=n,m=i[k++],n=j[l++]):(o=m,n=n-m,m=i[k++]),g.retain(o),h.retain(o);else if(d(m)&&d(n))-m>-n?(m=m-n,n=j[l++]):m===n?(m=i[k++],n=j[l++]):(n=n-m,m=i[k++]);else if(d(m)&&b(n))-m>n?(o=n,m=m+n,n=j[l++]):-m===n?(o=n,m=i[k++],n=j[l++]):(o=-m,n=n+m,m=i[k++]),g["delete"](o);else if(b(m)&&d(n))m>-n?(o=-n,m=m+n,n=j[l++]):m===-n?(o=m,m=i[k++],n=j[l++]):(o=m,n=n+m,m=i[k++]),h["delete"](o);else throw new Error("The two operations aren't compatible")}return[g,h]},a}(),typeof module=="object"&&(module.exports=ot.TextOperation);if(typeof ot=="undefined")var ot={};ot.Cursor=function(a){function c(a,b){this.position=a,this.selectionEnd=b}var b=a.ot?a.ot.TextOperation:require("./text-operation");return c.fromJSON=function(a){return new c(a.position,a.selectionEnd)},c.prototype.equals=function(a){return this.position===a.position&&this.selectionEnd===a.selectionEnd},c.prototype.compose=function(a){return a},c.prototype.transform=function(a){function d(c){var d=c,e=a.ops;for(var f=0,g=a.ops.length;f<g;f++){b.isRetain(e[f])?c-=e[f]:b.isInsert(e[f])?d+=e[f].length:(d-=Math.min(c,-e[f]),c+=e[f]);if(c<0)break}return d}var e=d(this.position);return this.position===this.selectionEnd?new c(e,e):new c(e,d(this.selectionEnd))},c}(this),typeof module=="object"&&(module.exports=ot.Cursor);if(typeof ot=="undefined")var ot={};ot.WrappedOperation=function(a){function b(a,b){this.wrapped=a,this.meta=b||{}}function c(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c])}function d(a,b){if(typeof a=="object"){if(typeof a.compose=="function")return a.compose(b);var d={};return c(a,d),c(b,d),d}return b}function e(a,b){return typeof a=="object"&&typeof a.transform=="function"?a.transform(b):a}return b.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},b.prototype.invert=function(){var a=this.meta;return new b(this.wrapped.invert.apply(this.wrapped,arguments),typeof a=="object"&&typeof a.invert=="function"?a.invert.apply(a,arguments):a)},b.prototype.compose=function(a){return new b(this.wrapped.compose(a.wrapped),d(this.meta,a.meta))},b.transform=function(a,c){var d=a.wrapped.constructor.transform,f=d(a.wrapped,c.wrapped);return[new b(f[0],e(a.meta,c.wrapped)),new b(f[1],e(c.meta,a.wrapped))]},b}(this),typeof module=="object"&&(module.exports=ot.WrappedOperation);if(typeof ot=="undefined")var ot={};ot.UndoManager=function(){function d(b){this.maxItems=b||50,this.state=a,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function e(a,b){var c=[],d=b.constructor;for(var e=a.length-1;e>=0;e--){var f=d.transform(a[e],b);(typeof f[0].isNoop!="function"||!f[0].isNoop())&&c.push(f[0]),b=f[1]}return c.reverse()}var a="normal",b="undoing",c="redoing";return d.prototype.add=function(a,d){if(this.state===b)this.redoStack.push(a),this.dontCompose=!0;else if(this.state===c)this.undoStack.push(a),this.dontCompose=!0;else{var e=this.undoStack;!this.dontCompose&&d&&e.length>0?e.push(a.compose(e.pop())):(e.push(a),e.length>this.maxItems&&e.shift()),this.dontCompose=!1,this.redoStack=[]}},d.prototype.transform=function(a){this.undoStack=e(this.undoStack,a),this.redoStack=e(this.redoStack,a)},d.prototype.performUndo=function(c){this.state=b;if(this.undoStack.length===0)throw new Error("undo not possible");c(this.undoStack.pop()),this.state=a},d.prototype.performRedo=function(b){this.state=c;if(this.redoStack.length===0)throw new Error("redo not possible");b(this.redoStack.pop()),this.state=a},d.prototype.canUndo=function(){return this.undoStack.length!==0},d.prototype.canRedo=function(){return this.redoStack.length!==0},d.prototype.isUndoing=function(){return this.state===b},d.prototype.isRedoing=function(){return this.state===c},d}(),typeof module=="object"&&(module.exports=ot.UndoManager);if(typeof ot=="undefined")var ot={};ot.Client=function(a){function b(a){this.revision=a,this.state=d}function c(){}function e(a){this.outstanding=a}function f(a,b){this.outstanding=a,this.buffer=b}b.prototype.setState=function(a){this.state=a},b.prototype.applyClient=function(a){this.setState(this.state.applyClient(this,a))},b.prototype.applyServer=function(a){this.revision++,this.setState(this.state.applyServer(this,a))},b.prototype.serverAck=function(){this.revision++,this.setState(this.state.serverAck(this))},b.prototype.sendOperation=function(a,b){throw new Error("sendOperation must be defined in child class")},b.prototype.applyOperation=function(a){throw new Error("applyOperation must be defined in child class")},b.Synchronized=c,c.prototype.applyClient=function(a,b){return a.sendOperation(a.revision,b),new e(b)},c.prototype.applyServer=function(a,b){return a.applyOperation(b),this},c.prototype.serverAck=function(a){throw new Error("There is no pending operation.")};var d=new c;return b.AwaitingConfirm=e,e.prototype.applyClient=function(a,b){return new f(this.outstanding,b)},e.prototype.applyServer=function(a,b){var c=b.constructor.transform(this.outstanding,b);return a.applyOperation(c[1]),new e(c[0])},e.prototype.serverAck=function(a){return d},b.AwaitingWithBuffer=f,f.prototype.applyClient=function(a,b){var c=this.buffer.compose(b);return new f(this.outstanding,c)},f.prototype.applyServer=function(a,b){var c=b.constructor.transform,d=c(this.outstanding,b),e=c(this.buffer,d[1]);return a.applyOperation(e[1]),new f(d[0],e[0])},f.prototype.serverAck=function(a){return a.sendOperation(a.revision,this.buffer),new e(this.buffer)},b}(this),typeof module=="object"&&(module.exports=ot.Client),ot.CodeMirrorAdapter=function(){function c(a){this.cm=a,this.silent=!1,this.oldValue=this.cm.getValue();var b=this;a.on("change",function(a,c){b.onChange(c)}),a.on("cursorActivity",function(){b.trigger("cursorActivity")})}function e(a,b){if(!a)throw new Error(b||"assertion error")}var a=ot.TextOperation,b=ot.Cursor;c.operationFromCodeMirrorChange=function(b,c){function f(a){var b=a.line,c=a.ch,d=0;for(var f=0;f<a.line;f++)d+=e[f].length+1;return d+=c,d}function g(){var a=0;for(var b=0,c=e.length;b<c;b++)a+=e[b].length;return a+e.length-1}function h(a,b){if(a.line===b.line)return e[a.line].slice(a.ch,b.ch);var c=e[a.line].slice(a.ch)+"\n";for(var d=a.line+1;d<b.line;d++)c+=e[d]+"\n";return c+=e[b.line].slice(0,b.ch),c}function i(a,b,c){var d=a.slice(0),f=e[b.line].slice(0,b.ch),g=e[c.line].slice(c.ch);d[0]=f+d[0],d[d.length-1]+=g,d.unshift(c.line-b.line+1),d.unshift(b.line),e.splice.apply(e,d)}function j(a,b){var c=f(b.from),d=f(b.to),e=g();a.retain(c),a["delete"](h(b.from,b.to)),a.insert(b.text.join("\n")),a.retain(e-d),i(b.text,b.from,b.to)}var d=new a,e=c.split("\n");j(d,b);for(;;){b=b.next;if(!b)break;var k=new a(d.revision+1);j(k,b),d=d.compose(k)}return d},c.applyOperationToCodeMirror=function(b,c){c.operation(function(){var d=b.ops,f=0;for(var g=0,h=d.length;g<h;g++){var i=d[g];if(a.isRetain(i))f+=i;else if(a.isInsert(i))c.replaceRange(i,c.posFromIndex(f)),f+=i.length;else if(a.isDelete(i)){var j=c.posFromIndex(f),k=c.posFromIndex(f-i);c.replaceRange("",j,k)}}e(f===c.getValue().length)})},c.prototype.registerCallbacks=function(a){this.callbacks=a},c.prototype.onChange=function(a){if(!this.silent){var b=c.operationFromCodeMirrorChange(a,this.oldValue);this.trigger("change",this.oldValue,b)}this.oldValue=this.cm.getValue()},c.prototype.getValue=function(){return this.oldValue},c.prototype.getCursor=function(){function a(a,b){return a.line===b.line&&a.ch===b.ch}var c=this.cm,d=c.getCursor(),e=c.indexFromPos(d),f;if(c.somethingSelected()){var g=c.getCursor(!0),h=a(d,g)?c.getCursor(!1):g;f=c.indexFromPos(h)}else f=e;return new b(e,f)},c.prototype.setCursor=function(a){this.cm.setSelection(this.cm.posFromIndex(a.position),this.cm.posFromIndex(a.selectionEnd))};var d=function(){var a={};return function(b){if(a[b])return;a[b]=!0;try{var c=document.styleSheets.item(0),d=(c.rules?c.rules:c.cssRules).length;c.insertRule(b,d)}catch(e){console.error("Couldn't add style rule.",e)}}}();return c.prototype.setOtherCursor=function(a,b){var c=this.cm.posFromIndex(a.position);if(a.position===a.selectionEnd){var e=this.cm.cursorCoords(c),f=document.createElement("pre");return f.className="other-client",f.style.borderLeftWidth="2px",f.style.borderLeftStyle="solid",f.innerHTML="&nbsp;",f.style.borderLeftColor=b,f.style.height=(e.bottom-e.top)*.85+"px",this.cm.addWidget(c,f,!1),{clear:function(){var a=f.parentNode;a&&a.removeChild(f)}}}var g=/^#([0-9a-fA-F]{6})$/.exec(b);if(!g)throw new Error("only six-digit hex colors are allowed.");var h="selection-"+g[1],i="."+h+" { background: "+b+"; }";d(i);var j,k;return a.selectionEnd>a.position?(j=c,k=this.cm.posFromIndex(a.selectionEnd)):(j=this.cm.posFromIndex(a.selectionEnd),k=c),this.cm.markText(j,k,{className:h})},c.prototype.trigger=function(a){var b=Array.prototype.slice.call(arguments,1),c=this.callbacks&&this.callbacks[a];c&&c.apply(this,b)},c.prototype.applyOperation=function(a){this.silent=!0,c.applyOperationToCodeMirror(a,this.cm),this.silent=!1},c.prototype.registerUndo=function(a){this.cm.undo=a},c.prototype.registerRedo=function(a){this.cm.redo=a},c}(),ot.SocketIOAdapter=function(){function a(a){this.socket=a;var b=this;a.on("client_left",function(a){b.trigger("client_left",a.clientId)}).on("set_name",function(a){b.trigger("set_name",a.clientId,a.name)}).on("ack",function(){b.trigger("ack")}).on("operation",function(a){b.trigger("operation",a)}).on("cursor",function(a){b.trigger("cursor",a.clientId,a.cursor)})}return a.prototype.sendOperation=function(a,b){b.revision=a,this.socket.emit("operation",b)},a.prototype.sendCursor=function(a){this.socket.emit("cursor",a)},a.prototype.registerCallbacks=function(a){this.callbacks=a},a.prototype.trigger=function(a){var b=Array.prototype.slice.call(arguments,1),c=this.callbacks&&this.callbacks[a];c&&c.apply(this,b)},a}(),ot.EditorClient=function(){function f(a,b){this.cursorBefore=a,this.cursorAfter=b}function g(a,b){this.clientId=a,this.cursor=b}function h(a,b,c,d,e){this.id=a,this.listEl=b,this.editorAdapter=c,this.name=d,this.li=document.createElement("li"),d&&(this.li.textContent=d,this.listEl.appendChild(this.li)),e&&this.updateCursor(e),this.setColor(d?l(d):Math.random())}function i(f,h,i,j){a.call(this,f),this.serverAdapter=i,this.editorAdapter=j,this.undoManager=new c,this.initializeClientList(),this.initializeClients(h);var k=this;this.editorAdapter.registerCallbacks({change:function(a,b){k.onChange(a,b)},cursorActivity:function(){k.onCursorActivity()}}),this.editorAdapter.registerUndo(function(){k.undo()}),this.editorAdapter.registerRedo(function(){k.redo()}),this.serverAdapter.registerCallbacks({client_left:function(a){k.onClientLeft(a)},set_name:function(a,b){k.getClientObject(a).setName(b)},ack:function(){k.serverAck()},operation:function(a){k.applyServer(new e(d.fromJSON(a.operation),g.fromJSON(a.meta)))},cursor:function(a,c){k.getClientObject(a).updateCursor(b.fromJSON(c))}})}function j(a,b,c){function d(a){var b=Math.round(255*a).toString(16);return b.length===1?"0"+b:b}return"#"+d(a)+d(b)+d(c)}function k(a,b,c){if(b===0)return j(c,c,c);var d=c<.5?c*(1+b):c+b-b*c,e=2*c-d,f=function(a){return a<0&&(a+=1),a>1&&(a-=1),6*a<1?e+(d-e)*6*a:2*a<1?d:3*a<2?e+(d-e)*6*(2/3-a):e};return j(f(a+1/3),f(a),f(a-1/3))}function l(a){var b=1;for(var c=0;c<a.length;c++)b=17*(b+a.charCodeAt(c))%360;return b/360}function m(a,b){function c(){}c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a}function n(a){return a[a.length-1]}function o(a){a.parentNode&&a.parentNode.removeChild(a)}var a=ot.Client,b=ot.Cursor,c=ot.UndoManager,d=ot.TextOperation,e=ot.WrappedOperation;return f.prototype.invert=function(){return new f(this.cursorAfter,this.cursorBefore)},f.prototype.compose=function(a){return new f(this.cursorBefore,a.cursorAfter)},f.prototype.transform=function(a){return new f(this.cursorBefore.transform(a),this.cursorAfter.transform(a))},g.fromJSON=function(a){return new g(a.clientId,b.fromJSON(a.cursor))},g.prototype.transform=function(a){return new g(this.clientId,this.cursor.transform(a))},h.prototype.setColor=function(a){this.hue=a,this.color=k(a,.75,.5),this.lightColor=k(a,.5,.9),this.li&&(this.li.style.color=this.color)},h.prototype.setName=function(a){this.name=a,this.li.textContent=a,this.li.parentNode||this.listEl.appendChild(this.li),this.setColor(l(a))},h.prototype.updateCursor=function(a){this.cursor=a,this.mark&&this.mark.clear(),this.mark=this.editorAdapter.setOtherCursor(a,a.position===a.selectionEnd?this.color:this.lightColor)},h.prototype.remove=function(){this.li&&o(this.li),this.mark&&this.mark.clear()},m(i,a),i.prototype.initializeClients=function(a){this.clients={};for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];d.clientId=c,this.clients[c]=new h(d.clientId,this.clientListEl,this.editorAdapter,d.name,d.cursor?b.fromJSON(d.cursor):null)}},i.prototype.getClientObject=function(a){var b=this.clients[a];return b?b:this.clients[a]=new h(a,this.clientListEl,this.editorAdapter)},i.prototype.onClientLeft=function(a){console.log("User disconnected: "+a);var b=this.clients[a];if(!b)return;b.remove(),delete this.clients[a]},i.prototype.initializeClientList=function(){this.clientListEl=document.createElement("ul")},i.prototype.applyUnredo=function(a){this.undoManager.add(a.invert(this.editorAdapter.getValue())),this.editorAdapter.applyOperation(a.wrapped),this.cursor=a.meta.cursorAfter,this.editorAdapter.setCursor(this.cursor),this.applyClient(a)},i.prototype.undo=function(){var a=this;this.undoManager.performUndo(function(b){a.applyUnredo(b)})},i.prototype.redo=function(){var a=this;this.undoManager.performRedo(function(b){a.applyUnredo(b)})},i.prototype.onChange=function(a,b){var c=this.cursor;this.updateCursor();var d=new f(c,this.cursor),g=new e(b,d),h=this.undoManager.undoStack.length>0&&!this.undoManager.dontCompose&&n(this.undoManager.undoStack).wrapped.invert(a).shouldBeComposedWith(b);this.undoManager.add(g.invert(a),h),this.applyClient(g)},i.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor()},i.prototype.onCursorActivity=function(){var b=this.cursor;this.updateCursor();if(b&&this.cursor.equals(b))return;if(this.state instanceof a.AwaitingWithBuffer)this.state.buffer.meta.cursorAfter=this.cursor;else{var c=this;this.serverAdapter.sendCursor(this.cursor)}},i.prototype.sendOperation=function(a,b){this.serverAdapter.sendOperation(a,{meta:{cursor:b.meta.cursorAfter},operation:b.wrapped.toJSON()})},i.prototype.applyOperation=function(a){this.editorAdapter.applyOperation(a.wrapped),this.updateCursor();var b=this.getClientObject(a.meta.clientId);b.updateCursor(a.meta.cursor),this.undoManager.transform(a)},i}();