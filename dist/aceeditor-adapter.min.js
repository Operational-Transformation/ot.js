/*
 *    /\
 *   /  \ ot 0.0.15
 *  /    \ http://operational-transformation.github.com
 *  \    /
 *   \  / (c) 2012-2022 Tim Baumann <tim@timbaumann.info> (http://timbaumann.info)
 *    \/ ot may be freely distributed under the MIT license.
 */
ot.AceEditorAdapter=function(){"use strict";var c=ot.TextOperation,a=ot.Selection,r="ot-ace-addon-other-cursor",l="ot-ace-addon-other-selection",h="data-client-name";function t(e){this.ae=e,this.aeElement=e.renderer.container,this.ignoreNextChange=!1,this.changeInProgress=!1,this.selectionChanged=!1,this.updateAceEditorSizes(),this.addStyles(),this.markersElement=document.createElement("div"),this.markersElement.id="ot-ace-addon-markers",this.markersElement.style.position="absolute",this.markersElement.style.inset="0",this.markersElement.style.left=this.LEFT_MARGIN+"px",this.markersElement.style.pointerEvents="none",this.aeElement.querySelector(".ace_scroller").appendChild(this.markersElement),o(this,"onChange"),o(this,"onCursorActivity"),o(this,"onFocus"),o(this,"onBlur"),o(this,"onScrollVertical"),o(this,"onScrollHorizontal"),e.on("change",this.onChange),e.on("changeSelection",this.onCursorActivity),e.on("focus",this.onFocus),e.on("blur",this.onBlur),e.session.on("changeScrollTop",this.onScrollVertical),e.session.on("changeScrollLeft",this.onScrollHorizontal)}function o(e,t){var o=e[t];e[t]=function(){o.apply(e,arguments)}}return t.prototype.updateAceEditorSizes=function(){this.LINE_HEIGHT=this.aeElement.querySelector(".ace_line").scrollHeight,this.LEFT_MARGIN=Number(this.aeElement.querySelector(".ace_text-layer").style.getPropertyValue("margin-left").replace(/px$/,""));var e=document.createElement("span");e.innerText="x".repeat(100),e.style.visibility="hidden",this.aeElement.appendChild(e),this.SYMBOL_WIDTH=e.offsetWidth/100,e.remove()},t.prototype.addStyles=function(){e={},t=document.createElement("style"),document.documentElement.getElementsByTagName("head")[0].appendChild(t),o=t.sheet;for(var e,t,o,n=["@keyframes ot-ace-addon-keep-hint-open {           0%, 80% {              content: attr("+h+");              width: unset;              height: 14px;              top: -20px;              padding: 4px;              opacity: 0.7;           }           99% {              top: "+-8+'px;              height: 8px;              width: 8px;              color: black;              opacity: 1;              padding: 0;              content: "";           }           100% {           }       }',"."+r+" {           display: inline-block;            padding: 0px;           margin-right: -1px;           margin-left: -1px;           z-index: 0;           position: absolute;           border-left-width: 2px;           border-left-style: solid;       }","."+r+'::after {           content: "";           pointer-events: all;           position: absolute;           inset: -5px -5px -5px -10px;       }',"."+r+'::before {           content: "";           position: absolute;           top: '+-8+"px;           left: "+-5+"px;           height: 8px;           width: 8px;           background: inherit;           font-size: 14px;           transition: all 0.2s ease;           line-height: 14px;           border-radius: 7px;           color: black;           white-space: nowrap;           animation: 2s ease ot-ace-addon-keep-hint-open;       }","."+r+":hover::before {           content: attr("+h+");           width: unset;           height: 14px;           top: -20px;           padding: 4px;           opacity: 0.85;       }","."+l+" {           display: inline-block;           padding: 0px;           z-index: 0;           position: absolute;           inset: 0;           opacity: 0.3;       }"],i=0;i<n.length;i++){var s=n[i];if(e[s])return;e[s]=!0,o.insertRule(s,(o.cssRules||o.rules).length)}},t.prototype.detach=function(){this.markersElement.remove(),this.ae.off("change",this.onChange),this.ae.off("changeSelection",this.onCursorActivity),this.ae.off("focus",this.onFocus),this.ae.off("blur",this.onBlur),this.ae.session.off("changeScrollTop",this.onScrollVertical),this.ae.session.off("changeScrollLeft",this.onScrollHorizontal)},t.operationFromAceEditorChange=t.operationFromAceEditorChanges=function(e,t){var o=t.getValue().length,n=(new c).retain(o),i=(new c).retain(o);function s(e){if(0===e.length)return 0;for(var t=0,o=0;o<e.length;o++)t+=e[o].length;return t+e.length-1}r=e.start;var t=t.session.doc.positionToIndex(r),r=o-t;return"insert"===e.action?(r-=s(e.lines),n=(new c).retain(t).insert(e.lines.join("\n")).retain(r).compose(n),i=i.compose((new c).retain(t).delete(s(e.lines)).retain(r))):"remove"===e.action&&(n=(new c).retain(t).delete(s(e.lines)).retain(r).compose(n),i=i.compose((new c).retain(t).insert(e.lines.join("\n")).retain(r))),[n,i]},t.applyOperationToAceEditor=function(e,t){for(var o=e.ops,n=0,i=0,s=o.length;i<s;i++){var r,a,l=o[i];c.isRetain(l)?n+=l:c.isInsert(l)?(a=t.session.doc.indexToPosition(n),t.session.doc.insert(a,l),n+=l.length):c.isDelete(l)&&(r=t.session.doc.indexToPosition(n),a=t.session.doc.indexToPosition(n-l),t.session.doc.remove(new ace.Range(r.row,r.column,a.row,a.column)))}},t.prototype.registerCallbacks=function(e){this.callbacks=e},t.prototype.onChange=function(e){this.changeInProgress=!0,this.ignoreNextChange||(e=t.operationFromAceEditorChanges(e,this.ae),this.trigger("change",e[0],e[1])),this.selectionChanged&&this.trigger("selectionChange"),this.changeInProgress=!1,this.ignoreNextChange=!1},t.prototype.onFocus=t.prototype.onCursorActivity=function(){this.changeInProgress?this.selectionChanged=!0:this.trigger("selectionChange")},t.prototype.onBlur=function(){this.ae.selection.isEmpty()&&this.trigger("blur")},t.prototype.onScrollVertical=function(e){this.markersElement.style.top=-e+"px"},t.prototype.onScrollHorizontal=function(e){this.markersElement.style.left=this.LEFT_MARGIN-e+"px"},t.prototype.getValue=function(){return this.ae.getValue()},t.prototype.getSelection=function(){for(var e,t=this.ae,o=t.selection.getAllRanges(),n=[],i=!0,s=0;s<o.length;s++){var r=o[s];n[s]=new a.Range(t.session.doc.positionToIndex({row:r.start.row,column:r.start.column}),t.session.doc.positionToIndex({row:r.end.row,column:r.end.column})),n[s].isEmpty()&&(i=!1)}return i&&(e=t.session.doc.positionToIndex(t.selection.getCursor()),n[n.length]=new a.Range(e,e)),new a(n)},t.prototype.setSelection=function(e){this.ae.selection.clearSelection();for(var t=0;t<e.ranges.length;t++){var o=e.ranges[t],n=this.ae.session.doc.indexToPosition(o.anchor),o=this.ae.session.doc.indexToPosition(o.head);this.ae.selection.addRange(new ace.Range(n.row,n.column,o.row,o.column))}},t.prototype.setOtherCursor=function(e,t,o,n){var e=this.ae.session.doc.indexToPosition(e),i=document.createElement("span");return i.classList.add(r),i.style.background=t,i.style.borderLeftColor=t,i.style.height=this.LINE_HEIGHT+"px",i.style.top=this.LINE_HEIGHT*e.row+"px",i.style.left=this.SYMBOL_WIDTH*e.column+"px",i.setAttribute(h,n),this.markersElement.appendChild(i),i},t.prototype.setOtherSelectionRange=function(e,t,o,n){for(var i=this.ae.session.doc.indexToPosition(e.anchor),s=this.ae.session.doc.indexToPosition(e.head),e=document.createElement("span"),t=(e.classList.add(l),e.style.background=t,e.setAttribute(h,n),'path("M '+this.SYMBOL_WIDTH*i.column+" "+this.LINE_HEIGHT*i.row+"  v "+this.LINE_HEIGHT),r="",a=i.row+1;a<s.row+1;a++)r+="h 10000 v "+-this.LINE_HEIGHT+"  M 0 "+this.LINE_HEIGHT*a+"  v "+this.LINE_HEIGHT;n="L "+this.SYMBOL_WIDTH*s.column+" "+(this.LINE_HEIGHT*s.row+this.LINE_HEIGHT)+" v "+-this.LINE_HEIGHT+'  Z")';return e.style.clipPath=t+r+n,this.markersElement.appendChild(e),e},t.prototype.setOtherSelection=function(e,t,o,n){for(var i=[],s=0;s<e.ranges.length;s++){var r=e.ranges[s];r.isEmpty()?i[s]=this.setOtherCursor(r.head,t,o,n):i[s]=this.setOtherSelectionRange(r,t,o,n)}return{clear:function(){for(var e=0;e<i.length;e++)i[e].remove()}}},t.prototype.trigger=function(e){var t=Array.prototype.slice.call(arguments,1),e=this.callbacks&&this.callbacks[e];e&&e.apply(this,t)},t.prototype.applyOperation=function(e){this.ignoreNextChange=!0,t.applyOperationToAceEditor(e,this.ae)},t.prototype.registerUndo=function(e){this.ae.undo=e},t.prototype.registerRedo=function(e){this.ae.redo=e},t}();